<div class="price-arbitrage-opportunities-container">
  <!-- Header -->
  <div class="page-header">
    <h1 class="page-title">Price Arbitrage Opportunities</h1>
    <p class="page-subtitle">Combined price spread + funding rate arbitrage strategy</p>
  </div>

  <!-- Controls and Header -->
  <div class="controls-section">
    <div class="filters">
      <div class="header-info">
        <h2 class="section-title">Opportunities</h2>
      </div>
    </div>

    <div class="status-section">
      <div class="last-updated">
        <ui-icon name="schedule" [size]="18"></ui-icon>
        <span>{{ timeSinceUpdate() }}</span>
      </div>
      <ui-button
        (clicked)="refresh()"
        [disabled]="isLoading()"
        variant="primary"
        size="medium"
      >
        <ui-icon name="refresh" [size]="20" [class]="isLoading() ? 'spinning' : ''"></ui-icon>
        Refresh
      </ui-button>
    </div>
  </div>

  <!-- Filters -->
      <div class="filters-section">
        <div class="filter-group">
          <label for="search">Symbol Search:</label>
          <input
            id="search"
            type="text"
            [(ngModel)]="searchQuery"
            placeholder="e.g., BTC, ETH, COAI"
            class="filter-input"
          />
        </div>

        <div class="filter-group">
          <label for="strategyType">Strategy Type:</label>
          <select id="strategyType" [(ngModel)]="strategyTypeFilter" class="filter-select">
            <option value="combined">Combined</option>
            <option value="price_only">Price Only</option>
            <option value="spot_futures">Spot + Futures</option>
            <option value="funding_farm">Funding Farm (Œî-Neutral)</option>
            <option value="graduated_entry">Graduated Entry (Spot+Futures)</option>
          </select>
        </div>

        <div class="filter-group">
          <label for="minScore">Min Score (%):</label>
          <input
            id="minScore"
            type="number"
            [(ngModel)]="minCombinedScore"
            placeholder="e.g., 1.0"
            step="0.1"
            min="0"
            class="filter-input filter-input-number"
          />
        </div>

        <div class="filter-group filter-group-exchanges">
          <label>Filter by Exchanges:</label>
          <div class="exchange-checkboxes">
            @for (exchange of availableExchanges; track exchange) {
              <button
                type="button"
                class="exchange-checkbox"
                [class.active]="isExchangeSelected(exchange)"
                (click)="toggleExchange(exchange)"
                [title]="isExchangeSelected(exchange) ? 'Click to hide ' + exchange : 'Click to show ' + exchange"
              >
                {{ exchange }}
              </button>
            }
            @if (availableExchanges.length > 0) {
              <div class="exchange-actions">
                <ui-button
                  type="button"
                  variant="secondary"
                  size="small"
                  (clicked)="selectAllExchanges()"
                  [className]="'btn-exchange-action'"
                >
                  All
                </ui-button>
                <ui-button
                  type="button"
                  variant="secondary"
                  size="small"
                  (clicked)="deselectAllExchanges()"
                  [className]="'btn-exchange-action'"
                >
                  None
                </ui-button>
              </div>
            }
          </div>
        </div>

        <div class="filter-actions">
          <ui-button (clicked)="clearFilters()" variant="danger" size="medium">
            <ui-icon name="clear" [size]="18"></ui-icon>
            Clear Filters
          </ui-button>
        </div>
      </div>

      <!-- Loading State -->
      @if (isLoading() && opportunities().length === 0) {
        <div class="loading-state">
          <ui-icon name="spinner" class="spinning"></ui-icon>
          <p>Loading opportunities...</p>
        </div>
      }

      <!-- Error State -->
      @if (error()) {
        <div class="error-state">
          <ui-icon name="alert-circle"></ui-icon>
          <p>{{ error() }}</p>
          <ui-button (clicked)="refresh()" variant="primary" size="medium">Try Again</ui-button>
        </div>
      }

      <!-- Opportunities Table -->
      @if (!isLoading() || opportunities().length > 0) {
        <div class="table-container">
          <div class="results-count">
            Found {{ filteredOpportunities().length }} opportunities
          </div>

          <table class="opportunities-table">
            <thead>
              <tr>
                <th (click)="setSortColumn('symbol')" class="sortable">
                  Symbol
                  <ui-icon
                    *ngIf="sortColumn() === 'symbol'"
                    [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                    [size]="16"
                  ></ui-icon>
                </th>
                @if (!isFundingFarmMode()) {
                  <th (click)="setSortColumn('spreadPercent')" class="sortable">
                    Price Spread
                    <ui-icon
                      *ngIf="sortColumn() === 'spreadPercent'"
                      [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                      [size]="16"
                    ></ui-icon>
                  </th>
                } @else {
                  <th>Hedge Ratio<br><small>(Œî-Neutral)</small></th>
                }
                <th (click)="setSortColumn('fundingDifferential')" class="sortable">
                  Funding Diff
                  <ui-icon
                    *ngIf="sortColumn() === 'fundingDifferential'"
                    [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                    [size]="16"
                  ></ui-icon>
                </th>
                <th (click)="setSortColumn('combinedScore')" class="sortable">
                  Combined Score
                  <ui-icon
                    *ngIf="sortColumn() === 'combinedScore'"
                    [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                    [size]="16"
                  ></ui-icon>
                </th>
                <th (click)="setSortColumn('expectedDailyReturn')" class="sortable">
                  Daily Return
                  <ui-icon
                    *ngIf="sortColumn() === 'expectedDailyReturn'"
                    [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                    [size]="16"
                  ></ui-icon>
                </th>
                <th (click)="setSortColumn('estimatedMonthlyROI')" class="sortable">
                  Monthly ROI
                  <ui-icon
                    *ngIf="sortColumn() === 'estimatedMonthlyROI'"
                    [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                    [size]="16"
                  ></ui-icon>
                </th>
                <th (click)="setSortColumn('volatility')" class="sortable">
                  Volatility 24h
                  <ui-icon
                    *ngIf="sortColumn() === 'volatility'"
                    [name]="sortDirection() === 'asc' ? 'arrow_upward' : 'arrow_downward'"
                    [size]="16"
                  ></ui-icon>
                </th>
                @if (!isSpotFuturesMode() && !isGraduatedEntryMode()) {
                  <th>Best Long<br><small>(Lower Price)</small></th>
                  <th>Best Short<br><small>(Higher Price)</small></th>
                } @else {
                  <th>Best Exchange<br><small>(Spot + Futures)</small></th>
                }
                <th>Strategy</th>
                <th>Actions</th>
              </tr>
            </thead>
            <tbody>
              <ng-container *ngFor="let opp of filteredOpportunities()">
                <tr class="opportunity-row" [class.highlight-combined]="opp.strategyType === 'combined'">
                  <!-- Symbol -->
                  <td class="symbol-cell">
                    <span class="symbol">{{ opp.symbol }}</span>
                  </td>

                  <!-- Price Spread / Hedge Ratio -->
                  @if (!isFundingFarmMode()) {
                    <td class="price-spread-cell">
                      <div class="price-spread-info">
                        <span class="spread-percent">{{ formatPercent((opp.priceSpread || 0) * 100) }}</span>
                        <span class="spread-usdt">{{ opp.priceSpreadUsdt || '0.00' }}</span>
                      </div>
                    </td>
                  } @else {
                    <td class="hedge-ratio-cell">
                      @if (isFundingRateOpportunity(opp)) {
                        <div class="hedge-ratio-info">
                          <span class="ratio-value">{{ formatHedgeRatio(opp) }}</span>
                          <span class="ratio-label">Long/Short</span>
                        </div>
                      } @else {
                        <span>‚Äî</span>
                      }
                    </td>
                  }

                  <!-- Funding Differential -->
                  <td class="funding-spread-cell">
                    <span class="funding-spread">
                      {{ opp.maxFundingSpreadPercent }}
                    </span>
                  </td>

                  <!-- Combined Score -->
                  <td class="combined-score-cell">
                    @if (opp.combinedScore !== undefined) {
                      <span class="metric-value metric-highlight">{{ formatPercent(opp.combinedScore) }}</span>
                    } @else {
                      <span class="metric-value">{{ formatPercent((opp.priceSpread || 0) * 100) }}</span>
                    }
                  </td>

                  <!-- Daily Return -->
                  <td class="daily-return-cell">
                    @if (opp.realisticMetrics) {
                      <div class="metric-realistic">
                        <span class="metric-value metric-highlight"
                              [title]="'Realistic: ' + formatPercent(opp.realisticMetrics.dailyReturn.realistic) + ' | Range: ' + formatPercent(opp.realisticMetrics.dailyReturn.pessimistic) + ' - ' + formatPercent(opp.realisticMetrics.dailyReturn.optimistic)">
                          {{ formatPercent(opp.realisticMetrics.dailyReturn.realistic) }}
                        </span>
                        <span class="metric-range"
                              [title]="'Based on ' + (opp.realisticMetrics.dataPoints || 0) + ' historical data points over ' + (opp.realisticMetrics.historicalPeriodDays || 7) + ' days'">
                          <small class="range-pessimistic">{{ formatPercent(opp.realisticMetrics.dailyReturn.pessimistic, 1) }}</small>
                          <small class="range-separator">-</small>
                          <small class="range-optimistic">{{ formatPercent(opp.realisticMetrics.dailyReturn.optimistic, 1) }}</small>
                        </span>
                        @if (opp.realisticMetrics.confidence) {
                          <span class="confidence-badge"
                                [class.high]="opp.realisticMetrics.confidence >= 70"
                                [class.medium]="opp.realisticMetrics.confidence >= 40 && opp.realisticMetrics.confidence < 70"
                                [class.low]="opp.realisticMetrics.confidence < 40"
                                [title]="'Confidence: ' + opp.realisticMetrics.confidence + '/100 (based on historical data quality)'">
                            {{ opp.realisticMetrics.confidence }}%
                          </span>
                        }
                      </div>
                    } @else if (opp.expectedDailyReturn !== undefined) {
                      <span class="metric-value">{{ formatPercent(opp.expectedDailyReturn) }}</span>
                    } @else {
                      <span class="metric-value">{{ formatPercent((opp.priceSpread || 0) * 100) }}</span>
                    }
                  </td>

                  <!-- Monthly ROI -->
                  <td class="monthly-roi-cell">
                    @if (opp.realisticMetrics) {
                      <div class="metric-realistic">
                        <span class="metric-value metric-highlight"
                              [title]="'Realistic: ' + formatPercent(opp.realisticMetrics.monthlyROI.realistic) + ' | Range: ' + formatPercent(opp.realisticMetrics.monthlyROI.pessimistic) + ' - ' + formatPercent(opp.realisticMetrics.monthlyROI.optimistic)">
                          {{ formatPercent(opp.realisticMetrics.monthlyROI.realistic) }}
                        </span>
                        <span class="metric-range"
                              [title]="'Based on ' + (opp.realisticMetrics.dataPoints || 0) + ' historical data points over ' + (opp.realisticMetrics.historicalPeriodDays || 7) + ' days'">
                          <small class="range-pessimistic">{{ formatPercent(opp.realisticMetrics.monthlyROI.pessimistic, 1) }}</small>
                          <small class="range-separator">-</small>
                          <small class="range-optimistic">{{ formatPercent(opp.realisticMetrics.monthlyROI.optimistic, 1) }}</small>
                        </span>
                        @if (opp.realisticMetrics.confidence) {
                          <span class="confidence-badge"
                                [class.high]="opp.realisticMetrics.confidence >= 70"
                                [class.medium]="opp.realisticMetrics.confidence >= 40 && opp.realisticMetrics.confidence < 70"
                                [class.low]="opp.realisticMetrics.confidence < 40"
                                [title]="'Confidence: ' + opp.realisticMetrics.confidence + '/100 (based on historical data quality)'">
                            {{ opp.realisticMetrics.confidence }}%
                          </span>
                        }
                      </div>
                    } @else if (opp.estimatedMonthlyROI !== undefined) {
                      <span class="metric-value metric-highlight">{{ formatPercent(opp.estimatedMonthlyROI) }}</span>
                    } @else {
                      <span class="metric-value">{{ formatPercent((opp.priceSpread || 0) * 100) }}</span>
                    }
                  </td>

                  <!-- Volatility 24h -->
                  <td class="volatility-cell">
                    @if (opp.volatility24hFormatted) {
                      <span class="metric-value">{{ opp.volatility24hFormatted }}</span>
                    } @else if (opp.volatility24h !== undefined) {
                      <span class="metric-value">{{ formatPercent(opp.volatility24h * 100) }}</span>
                    } @else {
                      <span class="metric-value">‚Äî</span>
                    }
                  </td>

                  @if (!isSpotFuturesMode() && !isGraduatedEntryMode()) {
                    <!-- Best Long (Lower Price) - Cross-Exchange -->
                    <td class="best-long-cell">
                      @if (asFundingRateOpportunity(opp); as fundingOpp) {
                        <div class="best-exchange">
                          <span class="exchange-name">{{ fundingOpp.bestLong.exchange }}</span>
                          <span class="funding-rate" [ngClass]="getFundingRateColorClass(fundingOpp.bestLong.fundingRate)">{{ formatFundingRate(fundingOpp.bestLong.fundingRate) }}</span>
                          <span class="price">${{ fundingOpp.bestLong.lastPrice }}</span>
                          <span class="time-to-funding">{{ formatTimeToFundingWithInterval(fundingOpp.bestLong) }}</span>
                        </div>
                      }
                    </td>

                    <!-- Best Short (Higher Price) - Cross-Exchange -->
                    <td class="best-short-cell">
                      @if (asFundingRateOpportunity(opp); as fundingOpp) {
                        <div class="best-exchange">
                          <span class="exchange-name">{{ fundingOpp.bestShort.exchange }}</span>
                          <span class="funding-rate" [ngClass]="getFundingRateColorClass(fundingOpp.bestShort.fundingRate)">{{ formatFundingRate(fundingOpp.bestShort.fundingRate) }}</span>
                          <span class="price">${{ fundingOpp.bestShort.lastPrice }}</span>
                          <span class="time-to-funding">{{ formatTimeToFundingWithInterval(fundingOpp.bestShort) }}</span>
                        </div>
                      }
                    </td>
                  } @else if (isGraduatedEntryMode()) {
                    <!-- Single Exchange for Graduated Entry (Spot+Futures) -->
                    <td class="best-exchange-cell">
                      @if (asGraduatedEntryOpportunity(opp); as gradOpp) {
                        <div class="best-exchange">
                          <span class="exchange-name">{{ gradOpp.exchange }}</span>
                          <span class="funding-rate positive">{{ formatPercent(gradOpp.fundingRate) }}</span>
                          <span class="price">${{ gradOpp.futuresPrice }}</span>
                          @if (gradOpp.nextFundingTime && gradOpp.fundingInterval) {
                            <span class="time-to-funding">{{ formatGraduatedEntryFundingTime(gradOpp.nextFundingTime, gradOpp.fundingInterval) }}</span>
                          }
                        </div>
                      } @else {
                        <span>‚Äî</span>
                      }
                    </td>
                  } @else {
                    <!-- Best Exchange for Spot-Futures (Cross-Exchange recommended) -->
                    <td class="best-exchange-cell">
                      @if (asFundingRateOpportunity(opp); as fundingOpp) {
                        @if (fundingOpp.spotFuturesBestExchange) {
                          <div class="best-exchange">
                            <span class="exchange-name">{{ fundingOpp.spotFuturesBestExchange.exchange }}</span>
                            <span class="funding-rate" [ngClass]="getFundingRateColorClass(fundingOpp.spotFuturesBestExchange.fundingRate)">{{ formatFundingRate(fundingOpp.spotFuturesBestExchange.fundingRate) }}</span>
                            <span class="price">${{ fundingOpp.spotFuturesBestExchange.lastPrice }}</span>
                            <span class="time-to-funding">{{ formatTimeToFundingWithInterval(fundingOpp.spotFuturesBestExchange) }}</span>
                          </div>
                        } @else {
                          <span>‚Äî</span>
                        }
                      } @else {
                        <span>‚Äî</span>
                      }
                    </td>
                  }

                  <!-- Strategy Type -->
                  <td class="strategy-cell">
                    <span class="badge" [ngClass]="getStrategyBadgeClass(opp.strategyType || 'price_only')">
                      {{ getStrategyTypeText(opp.strategyType || 'price_only') }}
                    </span>
                    @if (asFundingRateOpportunity(opp); as fundingOpp) {
                      @if (fundingOpp.recommendedStrategy === 'spot-futures') {
                        <span class="badge badge-recommendation" title="Spot-Futures –∞—Ä–±—ñ—Ç—Ä–∞–∂ —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –¥–ª—è –º–∞–∫—Å–∏–º–∞–ª—å–Ω–æ–≥–æ –ø—Ä–∏–±—É—Ç–∫—É">
                          üí° SF
                        </span>
                      }
                    }
                  </td>

                  <!-- Actions -->
                  <td class="actions-cell">
                    <!-- Analytics button for spread stability modal (only for cross-exchange) -->
                    @if (!isGraduatedEntryMode() && isFundingRateOpportunity(opp)) {
                      <ui-button
                        (clicked)="openDetailsModal(opp)"
                        variant="secondary"
                        size="small"
                        [iconOnly]="true"
                        [className]="'btn-analytics'"
                        [title]="'View historical stability metrics'"
                      >
                        <ui-icon name="analytics" [size]="20"></ui-icon>
                      </ui-button>
                    }
                    <!-- Start position button -->
                    <ui-button
                      (clicked)="startPosition(opp)"
                      variant="primary"
                      size="small"
                      [iconOnly]="true"
                      [className]="'btn-start-position'"
                    >
                      <ui-icon name="play_arrow" [size]="18"></ui-icon>
                    </ui-button>
                  </td>
                </tr>
              </ng-container>

              <!-- Empty state -->
              <tr *ngIf="filteredOpportunities().length === 0" class="empty-row">
                <td colspan="11" class="empty-cell">
                  <ui-icon name="info" [size]="48"></ui-icon>
                  <p>
                    @if (searchQuery() || minCombinedScore() || selectedExchanges().length > 0) {
                      No opportunities match your filters. Try adjusting your criteria.
                    } @else {
                      No arbitrage opportunities found for this strategy type. Try selecting a different strategy.
                    }
                  </p>
                </td>
              </tr>
            </tbody>
          </table>
        </div>
      }

  <!-- Help Text -->
  <div class="help-section">
    <h3>Understanding Combined Strategy</h3>
    <ul>
      <li><strong>Price Spread:</strong> Immediate profit opportunity from price difference between exchanges</li>
      <li><strong>Funding Diff:</strong> Net funding rate you receive/pay every 8 hours (SHORT - LONG)</li>
      <li><strong>Combined Score:</strong> Price spread + projected funding for 7 days</li>
      <li><strong>Daily Return:</strong> Expected daily profit based on 7-day historical average funding rates (spread + funding √ó 3)</li>
      <li><strong>Monthly ROI:</strong> Estimated profit over 30 days based on historical data (spread + funding √ó 90)</li>
    </ul>

    <h3>üìä Realistic Metrics (NEW)</h3>
    <ul>
      <li><strong>Historical Analysis:</strong> Return estimates are now based on 7 days of historical funding rate data</li>
      <li><strong>Pessimistic Scenario:</strong> Lower bound (average - 1 standard deviation) - worst case from historical data</li>
      <li><strong>Realistic Scenario:</strong> Middle estimate (historical average) - most likely outcome</li>
      <li><strong>Optimistic Scenario:</strong> Upper bound (average + 1 standard deviation) - best case from historical data</li>
      <li><strong>Confidence Score:</strong> Data quality indicator (0-100%) - higher means more reliable historical data</li>
      <li><strong>Green badge (70%+):</strong> High confidence - lots of historical data, consistent rates</li>
      <li><strong>Orange badge (40-70%):</strong> Medium confidence - moderate data, some variance</li>
      <li><strong>Red badge (&lt;40%):</strong> Low confidence - limited data or high variance</li>
    </ul>

    <h3>üí° Spot-Futures Recommendation</h3>
    <ul>
      <li><strong>When both funding rates are positive</strong>, Spot-Futures arbitrage is more profitable</li>
      <li><strong>Spot-Futures:</strong> Buy spot asset + Short futures on same exchange = earn FULL funding rate</li>
      <li><strong>Cross-Exchange:</strong> Short high funding + Long low funding = earn only the DIFFERENCE</li>
      <li><strong>Example:</strong> If exchange has +0.15% funding, Spot-Futures earns 0.15%, Cross-Exchange earns 0.15% - 0.05% = 0.10%</li>
    </ul>

    <h3>üè¶ Graduated Entry (Spot+Futures)</h3>
    <ul>
      <li><strong>Strategy:</strong> Buy spot asset + Open SHORT futures on SAME exchange</li>
      <li><strong>Profit Source:</strong> Earn FULL funding rate when longs pay shorts (positive funding)</li>
      <li><strong>Comparison:</strong> Earns MORE than cross-exchange when funding is positive</li>
      <li><strong>Example:</strong> If funding is +0.15%, you earn full 0.15%, not just differential</li>
      <li><strong>Risk:</strong> No price spread profit - relies entirely on funding rates</li>
      <li><strong>Capital Efficiency:</strong> Requires capital for both spot purchase and futures margin</li>
      <li><strong>Best For:</strong> High positive funding rates (0.1%+ per 8h)</li>
    </ul>

    <h3>üìä Strategy Comparison</h3>
    <table style="width: 100%; border-collapse: collapse; margin-top: 1rem;">
      <thead>
        <tr style="background: #f5f5f5;">
          <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Strategy</th>
          <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Exchanges</th>
          <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Profit Source</th>
          <th style="padding: 0.5rem; text-align: left; border: 1px solid #ddd;">Example Return</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td style="padding: 0.5rem; border: 1px solid #ddd;"><strong>Cross-Exchange</strong></td>
          <td style="padding: 0.5rem; border: 1px solid #ddd;">2 different exchanges</td>
          <td style="padding: 0.5rem; border: 1px solid #ddd;">Price spread + Funding differential</td>
          <td style="padding: 0.5rem; border: 1px solid #ddd;">0.05% spread + 0.10% funding diff</td>
        </tr>
        <tr>
          <td style="padding: 0.5rem; border: 1px solid #ddd;"><strong>Graduated Entry</strong></td>
          <td style="padding: 0.5rem; border: 1px solid #ddd;">1 exchange (spot + futures)</td>
          <td style="padding: 0.5rem; border: 1px solid #ddd;">FULL funding rate</td>
          <td style="padding: 0.5rem; border: 1px solid #ddd;">0.00% spread + 0.15% full funding</td>
        </tr>
      </tbody>
    </table>
  </div>
</div>

<!-- Spread Stability Details Modal -->
<ui-dialog
  [open]="showDetailsModal()"
  [title]="selectedOpportunity() ? selectedOpportunity()!.symbol + ' - Spread Stability Analysis' : 'Loading...'"
  size="xlarge"
  [closable]="true"
  [closeOnBackdrop]="true"
  (close)="closeDetailsModal()"
>
  <ui-dialog-content>
    @if (selectedOpportunity(); as opp) {
      <app-funding-spread-details
        [opportunity]="mapToDetailsOpportunity(opp)"
      ></app-funding-spread-details>
    }
  </ui-dialog-content>
</ui-dialog>
