<div class="execution-progress">
  <div class="stepper">
    @for (leg of position.legs; track leg.legNumber) {
      <div class="step" [class.active]="leg.status === 'executing'" [class.completed]="leg.status === 'completed'" [class.error]="leg.status === 'error'">
        <!-- Step Indicator -->
        <div class="step-indicator">
          <div class="step-number" [class]="getStatusClass(leg.status)">
            @if (leg.status === 'completed') {
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M20 6L9 17l-5-5" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
              </svg>
            } @else if (leg.status === 'executing') {
              <div class="spinner-small"></div>
            } @else if (leg.status === 'error') {
              <svg width="24" height="24" viewBox="0 0 24 24" fill="none">
                <path d="M6 18L18 6M6 6l12 12" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
            } @else {
              <span>{{ leg.legNumber }}</span>
            }
          </div>
          @if (leg.legNumber < 3) {
            <div class="step-connector" [class.completed]="isNextLegNotPending(leg.legNumber)"></div>
          }
        </div>

        <!-- Step Content -->
        <div class="step-content">
          <div class="step-header">
            <h4 class="step-title">{{ translate('triangularArbitrage.execution.leg') }} {{ leg.legNumber }}: {{ leg.symbol }}</h4>
            <span class="step-status" [class]="getStatusClass(leg.status)">
              {{ translate('triangularArbitrage.execution.status.' + leg.status) }}
            </span>
          </div>

          <div class="step-details">
            <div class="detail-row">
              <span class="detail-label">{{ translate('triangularArbitrage.execution.side') }}:</span>
              <span class="detail-value" [class.buy]="leg.side === 'buy'" [class.sell]="leg.side === 'sell'">
                {{ leg.side.toUpperCase() }}
              </span>
            </div>

            @if (leg.status !== 'pending') {
              <div class="detail-row">
                <span class="detail-label">{{ translate('triangularArbitrage.execution.filled') }}:</span>
                <span class="detail-value">
                  {{ leg.filledQuantity }} / {{ leg.targetQuantity }}
                  <span class="fill-percentage">({{ getFillPercentage(leg).toFixed(1) }}%)</span>
                </span>
              </div>

              <!-- Progress Bar -->
              <div class="progress-bar">
                <div class="progress-fill" [style.width.%]="getFillPercentage(leg)"></div>
              </div>

              @if (leg.averagePrice) {
                <div class="detail-row">
                  <span class="detail-label">{{ translate('triangularArbitrage.execution.avgPrice') }}:</span>
                  <span class="detail-value">${{ leg.averagePrice.toFixed(8) }}</span>
                </div>
              }

              @if (leg.slippage !== undefined) {
                <div class="detail-row">
                  <span class="detail-label">{{ translate('triangularArbitrage.execution.slippage') }}:</span>
                  <span class="detail-value" [class.high]="leg.slippage > 0.2">{{ leg.slippage.toFixed(3) }}%</span>
                </div>
              }

              @if (leg.fee) {
                <div class="detail-row">
                  <span class="detail-label">{{ translate('triangularArbitrage.execution.fee') }}:</span>
                  <span class="detail-value">${{ leg.fee.toFixed(6) }} ({{ leg.feePercentage?.toFixed(3) }}%)</span>
                </div>
              }

              @if (leg.executionTimeMs) {
                <div class="detail-row">
                  <span class="detail-label">{{ translate('triangularArbitrage.execution.time') }}:</span>
                  <span class="detail-value">{{ formatExecutionTime(leg.executionTimeMs) }}</span>
                </div>
              }
            }

            @if (leg.error) {
              <div class="error-message">
                <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
                  <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                  <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
                </svg>
                <span>{{ leg.error }}</span>
              </div>
            }
          </div>
        </div>
      </div>
    }
  </div>

  <!-- Summary -->
  <div class="execution-summary">
    <h4>{{ translate('triangularArbitrage.execution.summary') }}</h4>
    <div class="summary-grid">
      <div class="summary-item">
        <span class="summary-label">{{ translate('triangularArbitrage.execution.totalFees') }}</span>
        <span class="summary-value">${{ position.totalFees.toFixed(6) }}</span>
      </div>
      <div class="summary-item">
        <span class="summary-label">{{ translate('triangularArbitrage.execution.totalSlippage') }}</span>
        <span class="summary-value">{{ position.totalSlippage.toFixed(3) }}%</span>
      </div>
      @if (position.executionTimeMs) {
        <div class="summary-item">
          <span class="summary-label">{{ translate('triangularArbitrage.execution.totalTime') }}</span>
          <span class="summary-value">{{ formatExecutionTime(position.executionTimeMs) }}</span>
        </div>
      }
      @if (position.actualProfit !== undefined) {
        <div class="summary-item summary-profit">
          <span class="summary-label">{{ translate('triangularArbitrage.execution.actualProfit') }}</span>
          <span class="summary-value profit" [class.positive]="position.actualProfit > 0" [class.negative]="position.actualProfit < 0">
            ${{ position.actualProfit.toFixed(2) }} ({{ position.actualProfitPercentage?.toFixed(3) }}%)
          </span>
        </div>
      }
    </div>
  </div>
</div>
