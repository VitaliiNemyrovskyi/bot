<div class="position-history">
  <!-- Toolbar -->
  <div class="toolbar">
    <ui-button variant="ghost" (clicked)="showFilters.set(!showFilters())">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M3 4h18M3 12h12M3 20h6" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
      </svg>
      {{ translate('triangularArbitrage.positions.filters') }}
    </ui-button>

    <ui-button variant="ghost" (clicked)="exportToCSV()" [disabled]="positions.length === 0">
      <svg width="16" height="16" viewBox="0 0 24 24" fill="none">
        <path d="M21 15v4a2 2 0 01-2 2H5a2 2 0 01-2-2v-4M7 10l5 5 5-5M12 15V3" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
      </svg>
      {{ translate('triangularArbitrage.positions.export') }}
    </ui-button>
  </div>

  <!-- Filters Panel -->
  @if (showFilters()) {
    <div class="filters-panel">
      <div class="filter-section">
        <label>{{ translate('triangularArbitrage.positions.filterByStatus') }}</label>
        <div class="status-filters">
          @for (status of availableStatuses; track status) {
            <button
              class="filter-chip"
              [class.active]="isStatusFiltered(status)"
              (click)="toggleStatusFilter(status)"
            >
              <span [class]="getStatusBadgeClass(status)">{{ translate('triangularArbitrage.positions.status.' + status) }}</span>
            </button>
          }
        </div>
      </div>

      <div class="filter-section">
        <label>{{ translate('triangularArbitrage.positions.filterByDate') }}</label>
        <div class="date-filters">
          <input
            type="date"
            [(ngModel)]="dateFrom"
            class="date-input"
            (change)="applyDateFilter()"
          />
          <span>to</span>
          <input
            type="date"
            [(ngModel)]="dateTo"
            class="date-input"
            (change)="applyDateFilter()"
          />
        </div>
      </div>

      <ui-button variant="ghost" size="small" (clicked)="clearFilters()">
        {{ translate('triangularArbitrage.positions.clearFilters') }}
      </ui-button>
    </div>
  }

  <!-- Loading State -->
  @if (isLoading) {
    <div class="loading-container">
      <div class="spinner"></div>
      <p>{{ translate('triangularArbitrage.positions.loading') }}</p>
    </div>
  }

  <!-- Empty State -->
  @else if (positions.length === 0) {
    <div class="empty-state">
      <svg width="64" height="64" viewBox="0 0 24 24" fill="none" class="empty-icon">
        <rect x="3" y="3" width="18" height="18" rx="2" stroke="currentColor" stroke-width="2"/>
        <path d="M3 9h18M9 21V9" stroke="currentColor" stroke-width="2"/>
      </svg>
      <h3>{{ translate('triangularArbitrage.positions.noPositions') }}</h3>
      <p>{{ translate('triangularArbitrage.positions.noPositionsHint') }}</p>
    </div>
  }

  <!-- Positions Table -->
  @else {
    <div class="table-container">
      <table class="positions-table">
        <thead>
          <tr>
            <th>{{ translate('triangularArbitrage.positions.table.id') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.triangle') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.status') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.entryAmount') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.expectedProfit') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.actualProfit') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.executionTime') }}</th>
            <th>{{ translate('triangularArbitrage.positions.table.actions') }}</th>
          </tr>
        </thead>
        <tbody>
          @for (position of positions; track position.id) {
            <tr (click)="openDetail(position)">
              <td>
                <span class="position-id">{{ position.id.substring(0, 8) }}...</span>
              </td>
              <td>
                <span class="triangle-path">{{ formatTriangle(position) }}</span>
              </td>
              <td>
                <span [class]="getStatusBadgeClass(position.status)">
                  {{ translate('triangularArbitrage.positions.status.' + position.status) }}
                </span>
              </td>
              <td>
                <span class="amount">${{ position.entryAmount.toFixed(2) }}</span>
              </td>
              <td>
                <span class="profit-expected">
                  ${{ position.expectedProfit.toFixed(2) }}
                  <span class="percentage">({{ position.expectedProfitPercentage.toFixed(2) }}%)</span>
                </span>
              </td>
              <td>
                @if (position.actualProfit !== undefined) {
                  <span [class]="'profit-actual ' + getProfitClass(position.actualProfit)">
                    ${{ position.actualProfit.toFixed(2) }}
                    <span class="percentage">({{ position.actualProfitPercentage?.toFixed(2) }}%)</span>
                  </span>
                } @else {
                  <span class="text-muted">â€”</span>
                }
              </td>
              <td>
                <span class="execution-time">{{ formatExecutionTime(position.executionTimeMs) }}</span>
              </td>
              <td class="actions-cell" (click)="$event.stopPropagation()">
                <div class="action-buttons">
                  @if (position.status === 'executing' || position.status === 'pending') {
                    <ui-button variant="danger" size="small" (clicked)="onCancel(position)">
                      {{ translate('triangularArbitrage.positions.cancel') }}
                    </ui-button>
                  } @else {
                    <ui-button variant="ghost" size="small" (clicked)="openDetail(position)">
                      {{ translate('triangularArbitrage.positions.viewDetails') }}
                    </ui-button>
                    <ui-button variant="danger" size="small" (clicked)="onDelete(position)">
                      <svg width="14" height="14" viewBox="0 0 24 24" fill="none">
                        <path d="M3 6h18M19 6v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6m3 0V4a2 2 0 012-2h4a2 2 0 012 2v2M10 11v6M14 11v6" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                      </svg>
                      {{ translate('triangularArbitrage.positions.delete') }}
                    </ui-button>
                  }
                </div>
              </td>
            </tr>
          }
        </tbody>
      </table>
    </div>
  }

  <!-- Detail Modal -->
  @if (showDetailModal() && selectedPosition(); as position) {
    <ui-dialog [open]="showDetailModal()" (openChange)="closeDetail()">
      <ui-dialog-header>
        <ui-dialog-title>
          {{ translate('triangularArbitrage.positions.details.title') }} - {{ position.id.substring(0, 12) }}
        </ui-dialog-title>
      </ui-dialog-header>
      <ui-dialog-content>
        <div class="position-details">
          <!-- Overview -->
          <div class="overview-section">
            <div class="overview-grid">
              <div class="overview-item">
                <span class="overview-label">{{ translate('triangularArbitrage.positions.details.exchange') }}</span>
                <span class="overview-value">{{ position.exchange }}</span>
              </div>
              <div class="overview-item">
                <span class="overview-label">{{ translate('triangularArbitrage.positions.details.triangle') }}</span>
                <span class="overview-value">{{ formatTriangle(position) }}</span>
              </div>
              <div class="overview-item">
                <span class="overview-label">{{ translate('triangularArbitrage.positions.details.status') }}</span>
                <span [class]="getStatusBadgeClass(position.status)">
                  {{ translate('triangularArbitrage.positions.status.' + position.status) }}
                </span>
              </div>
              <div class="overview-item">
                <span class="overview-label">{{ translate('triangularArbitrage.positions.details.created') }}</span>
                <span class="overview-value">{{ formatDate(position.createdAt) }}</span>
              </div>
            </div>
          </div>

          <!-- Execution Progress -->
          <app-execution-progress [position]="position" />

          <!-- Error Message -->
          @if (position.error) {
            <div class="error-section">
              <svg width="20" height="20" viewBox="0 0 24 24" fill="none">
                <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
                <path d="M12 8v4m0 4h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
              </svg>
              <div>
                <strong>{{ translate('triangularArbitrage.positions.details.error') }}</strong>
                <p>{{ position.error }}</p>
                @if (position.errorLeg) {
                  <p>{{ translate('triangularArbitrage.positions.details.failedAtLeg') }} {{ position.errorLeg }}</p>
                }
              </div>
            </div>
          }
        </div>
      </ui-dialog-content>
      <ui-dialog-footer>
        <ui-button variant="ghost" (clicked)="closeDetail()">
          {{ translate('triangularArbitrage.positions.details.close') }}
        </ui-button>
        @if (position.status === 'executing' || position.status === 'pending') {
          <ui-button variant="danger" (clicked)="onCancel(position); closeDetail()">
            {{ translate('triangularArbitrage.positions.cancel') }}
          </ui-button>
        } @else {
          <ui-button variant="danger" (clicked)="onDelete(position); closeDetail()">
            {{ translate('triangularArbitrage.positions.delete') }}
          </ui-button>
        }
      </ui-dialog-footer>
    </ui-dialog>
  }
</div>
