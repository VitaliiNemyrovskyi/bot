<div class="api-tester-container">
  <!-- Header -->
  <div class="api-tester-header">
    <div class="header-content">
      <h1 class="page-title">Exchange Order API Tester</h1>
      <p class="page-description">Test exchange order placement with detailed request/response inspection</p>
    </div>
    <div class="header-actions">
      <button
        type="button"
        class="btn-secondary btn-sm"
        (click)="clearAllLogs()"
        [disabled]="logs().length === 0"
      >
        Clear History
      </button>
    </div>
  </div>

  <!-- Configuration Panel -->
  <div class="config-panel">
    <h2 class="section-title">Configuration</h2>

    <div class="config-grid">
      <!-- Exchange Selection -->
      <div class="form-group">
        <label for="exchange" class="form-label">
          Exchange
          <span class="required">*</span>
        </label>
        <select
          id="exchange"
          class="form-control"
          [value]="selectedExchange()"
          (change)="onExchangeChange($any($event.target).value)"
        >
          <option [value]="null">Select Exchange...</option>
          @for (option of exchangeOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Credential Selection -->
      <div class="form-group">
        <label for="credential" class="form-label">
          API Credential
          <span class="required">*</span>
        </label>
        <select
          id="credential"
          class="form-control"
          [disabled]="!selectedExchange() || availableCredentials().length === 0"
          [value]="selectedCredential()?.id"
          (change)="onCredentialChange($any($event.target).value)"
        >
          <option [value]="null">Select Credential...</option>
          @for (cred of availableCredentials(); track cred.id) {
            <option [value]="cred.id">
              {{ cred.label || cred.apiKeyPreview }} ({{ cred.environment }})
            </option>
          }
        </select>
        @if (selectedExchange() && availableCredentials().length === 0) {
          <p class="help-text error">No credentials configured for this exchange</p>
        }
      </div>
    </div>
  </div>

  <!-- Order Parameters Form -->
  <form [formGroup]="orderForm" class="parameters-panel">
    <h2 class="section-title">Order Parameters</h2>

    <div class="parameters-grid">
      <!-- Symbol -->
      <div class="form-group">
        <label for="symbol" class="form-label">
          Symbol
          <span class="required">*</span>
        </label>
        <input
          id="symbol"
          type="text"
          formControlName="symbol"
          class="form-control"
          placeholder="BTC-USDT"
          [class.error]="hasError('symbol')"
        />
        @if (hasError('symbol')) {
          <p class="help-text error">{{ getErrorMessage('symbol') }}</p>
        }
        <p class="help-text">Format: BASE-QUOTE (e.g., BTC-USDT)</p>
      </div>

      <!-- Side -->
      <div class="form-group">
        <label for="side" class="form-label">
          Side
          <span class="required">*</span>
        </label>
        <select
          id="side"
          formControlName="side"
          class="form-control"
        >
          @for (option of orderSideOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Position Side -->
      <div class="form-group">
        <label for="positionSide" class="form-label">
          Position Side
          <span class="required">*</span>
        </label>
        <select
          id="positionSide"
          formControlName="positionSide"
          class="form-control"
        >
          @for (option of positionSideOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
      </div>

      <!-- Order Type -->
      <div class="form-group">
        <label for="type" class="form-label">
          Order Type
          <span class="required">*</span>
        </label>
        <select
          id="type"
          formControlName="type"
          class="form-control"
        >
          @for (option of orderTypeOptions; track option.value) {
            <option [value]="option.value">{{ option.label }}</option>
          }
        </select>
        <p class="help-text">{{ orderForm.value.type === OrderType.MARKET ? 'Execute at current market price' : 'Execute at specified price or better' }}</p>
      </div>

      <!-- Quantity -->
      <div class="form-group">
        <label for="quantity" class="form-label">
          Quantity
          <span class="required">*</span>
        </label>
        <input
          id="quantity"
          type="number"
          formControlName="quantity"
          class="form-control"
          placeholder="0.001"
          step="0.001"
          min="0"
          [class.error]="hasError('quantity')"
        />
        @if (hasError('quantity')) {
          <p class="help-text error">{{ getErrorMessage('quantity') }}</p>
        }
      </div>

      <!-- Price (for LIMIT orders) -->
      <div class="form-group">
        <label for="price" class="form-label">
          Price
          @if (orderForm.value.type === OrderType.LIMIT) {
            <span class="required">*</span>
          }
        </label>
        <input
          id="price"
          type="number"
          formControlName="price"
          class="form-control"
          placeholder="Enter price"
          step="0.01"
          min="0"
          [class.error]="hasError('price')"
        />
        @if (hasError('price')) {
          <p class="help-text error">{{ getErrorMessage('price') }}</p>
        }
        @if (orderForm.value.type !== OrderType.LIMIT) {
          <p class="help-text">Price is only required for LIMIT orders</p>
        }
      </div>
    </div>

    <!-- Submit Button -->
    <div class="submit-section">
      <button
        type="button"
        class="btn-primary btn-lg"
        (click)="onSubmitRequest()"
        [disabled]="!canSubmit()"
      >
        @if (isLoading()) {
          <span class="spinner"></span>
          Sending Request...
        } @else {
          <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M22 2L11 13M22 2l-7 20-4-9-9-4 20-7z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          Send Request
        }
      </button>

      @if (error()) {
        <div class="error-banner">
          <svg class="icon" width="20" height="20" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <circle cx="12" cy="12" r="10" stroke="currentColor" stroke-width="2"/>
            <path d="M12 8v4M12 16h.01" stroke="currentColor" stroke-width="2" stroke-linecap="round"/>
          </svg>
          {{ error() }}
        </div>
      }
    </div>
  </form>

  <!-- Request/Response Display -->
  @if (currentLog()) {
    <div class="log-display">
      <!-- Request Section -->
      <div class="log-section request-section">
        <div class="section-header">
          <h3 class="section-title">Request</h3>
          <button
            type="button"
            class="btn-icon"
            (click)="copyRequest()"
            title="Copy to clipboard"
          >
            <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
              <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
              <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2"/>
            </svg>
          </button>
        </div>

        <div class="request-info">
          <span class="http-method">{{ currentLog()!.method }}</span>
          <span class="endpoint">{{ currentLog()!.endpoint }}</span>
        </div>

        <div class="code-block">
          <pre><code>{{ formatJson(currentLog()!.requestBody) }}</code></pre>
        </div>
      </div>

      <!-- Response Section -->
      <div class="log-section response-section">
        <div class="section-header">
          <h3 class="section-title">Response</h3>
          <div class="header-actions">
            <span class="status-badge" [ngClass]="getStatusCodeClass(currentLog()!.statusCode)">
              {{ currentLog()!.statusCode }} {{ getStatusCodeLabel(currentLog()!.statusCode) }}
            </span>
            @if (currentLog()!.responseTime) {
              <span class="response-time">{{ currentLog()!.responseTime }}ms</span>
            }
            <button
              type="button"
              class="btn-icon"
              (click)="copyResponse()"
              title="Copy to clipboard"
            >
              <svg class="icon" width="18" height="18" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                <rect x="9" y="9" width="13" height="13" rx="2" ry="2" stroke="currentColor" stroke-width="2"/>
                <path d="M5 15H4a2 2 0 0 1-2-2V4a2 2 0 0 1 2-2h9a2 2 0 0 1 2 2v1" stroke="currentColor" stroke-width="2"/>
              </svg>
            </button>
          </div>
        </div>

        <div class="code-block" [ngClass]="{'response-error': !currentLog()!.success}">
          <pre><code>{{ formatJson(currentLog()!.responseBody) }}</code></pre>
        </div>
      </div>
    </div>
  }

  <!-- History Section -->
  @if (logs().length > 1) {
    <div class="history-section">
      <h2 class="section-title">Request History</h2>

      <div class="history-list">
        @for (log of logs(); track log.timestamp) {
          @if (log !== currentLog()) {
            <div class="history-item" (click)="currentLog.set(log)">
              <div class="history-item-header">
                <span class="http-method">{{ log.method }}</span>
                <span class="endpoint">{{ log.endpoint }}</span>
                <span class="status-badge" [ngClass]="getStatusCodeClass(log.statusCode)">
                  {{ log.statusCode }}
                </span>
              </div>
              <div class="history-item-meta">
                <span class="timestamp">{{ log.timestamp | date:'short' }}</span>
                @if (log.responseTime) {
                  <span class="response-time">{{ log.responseTime }}ms</span>
                }
              </div>
            </div>
          }
        }
      </div>
    </div>
  }
</div>
