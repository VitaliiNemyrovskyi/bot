<div class="arbitrage-chart-container">
  <!-- Header -->
  <div id="chart-header" class="chart-header">
    <div class="header-content">
      <button class="back-button" (click)="goBack()">
        ‚Üê {{ t('arbitrageChart.back') }}
      </button>
      <h1 class="chart-title">
        {{ symbol() }} {{ t('arbitrageChart.title') }}
      </h1>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div id="loading-state" class="loading-container">
      <div class="loading-spinner"></div>
      <p>{{ t('arbitrageChart.loading') }}</p>
    </div>
  } @else {
    <!-- Historical Data Loading Indicator -->
    @if (loadingHistoricalData()) {
      <div id="historical-loading" class="historical-data-loading">
        <div class="loading-spinner-small"></div>
        <span>{{ t('arbitrageChart.loadingHistorical') }}</span>
      </div>
    }
    <!-- Main Content Layout: Chart (2/3) + Info Panel (1/3) -->
    <div id="main-content" class="main-content">
      <!-- Left Side: Chart (2/3 width) -->
      <div id="chart-section" class="chart-section">
        <div id="chart-card" class="chart-card">
          <div class="chart-card-header">
            <div class="header-left">
              <div class="spread-badges">
                <div class="spread-badge price-spread"
                     [class.favorable]="getPriceSpreadClass() === 'favorable'"
                     [class.unfavorable]="getPriceSpreadClass() === 'unfavorable'">
                  {{ t('arbitrageChart.priceSpread') }}: {{ spreadPercent() }}%
                </div>
                <div class="spread-badge funding-spread"
                     [class.positive]="fundingSpread() > 0"
                     [class.negative]="fundingSpread() < 0">
                  {{ t('arbitrageChart.fundingSpread') }}: {{ formatFundingSpread() }}
                </div>
              </div>
            </div>
            <div class="header-right">
              <button
                class="fit-content-btn"
                (click)="fitContent()"
                [title]="t('arbitrageChart.fitTooltip')">
                <span>üìä</span> {{ t('arbitrageChart.fit') }}
              </button>
              <div class="timeframe-selector">
                <button
                  *ngFor="let tf of timeframeOptions"
                  class="timeframe-btn"
                  [class.active]="selectedTimeframe() === tf.value"
                  (click)="changeTimeframe(tf.value)">
                  {{ tf.label }}
                </button>
              </div>
            </div>
          </div>
          <div #chartContainer id="chart-container" class="chart-container"></div>
        </div>

        <!-- Active Positions Table -->
        <div id="active-positions-section" class="active-positions-section">
          <div class="section-header">
            <h2>{{ t('arbitrageChart.activePositions') }}</h2>
            <span class="positions-count">{{ filteredActivePositions().length }} {{ t('arbitrageChart.positionCount') }}</span>
          </div>

          @if (filteredActivePositions().length === 0) {
            <div id="no-positions" class="no-positions">
              <span class="icon">üìä</span>
              <p>{{ t('arbitrageChart.noPositions') }}</p>
              <small>{{ t('arbitrageChart.startPosition') }}</small>
            </div>
          } @else {
            <div id="positions-table-container" class="positions-table-container">
              <table id="positions-table" class="positions-table">
                <thead>
                  <tr>
                    <th>{{ t('arbitrageChart.table.positionId') }}</th>
                    <th>{{ t('arbitrageChart.table.symbol') }}</th>
                    <th>{{ t('arbitrageChart.table.primaryExchange') }}</th>
                    <th>{{ t('arbitrageChart.table.hedgeExchange') }}</th>
                    <th>{{ t('arbitrageChart.table.status') }}</th>
                    <th>{{ t('arbitrageChart.table.startedAt') }}</th>
                    <th>{{ t('arbitrageChart.table.actions') }}</th>
                  </tr>
                </thead>
                <tbody>
                  @for (position of filteredActivePositions(); track position.positionId) {
                    <!-- Main Row (clickable) -->
                    <tr class="position-row" [class.expanded]="isRowExpanded(position.positionId)" (click)="toggleRowExpansion(position.positionId)">
                      <td class="position-id">
                        <span class="expand-icon">{{ isRowExpanded(position.positionId) ? '‚ñº' : '‚ñ∂' }}</span>
                        {{ position.positionId }}
                      </td>
                      <td class="symbol">{{ position.symbol }}</td>
                      <td class="exchange">
                        <div class="exchange-cell">
                          <span class="exchange-name">{{ position.primary.exchange }}</span>
                          <span class="side-badge" [class.long]="position.primary.side === 'long'" [class.short]="position.primary.side === 'short'">
                            {{ position.primary.side }}
                          </span>
                          <span class="leverage">{{ position.primary.leverage }}x</span>
                        </div>
                      </td>
                      <td class="exchange">
                        <div class="exchange-cell">
                          <span class="exchange-name">{{ position.hedge.exchange }}</span>
                          <span class="side-badge" [class.long]="position.hedge.side === 'long'" [class.short]="position.hedge.side === 'short'">
                            {{ position.hedge.side }}
                          </span>
                          <span class="leverage">{{ position.hedge.leverage }}x</span>
                        </div>
                      </td>
                      <td class="status">
                        <span class="status-badge" [ngClass]="getStatusBadge(position.status).class">
                          {{ getStatusBadge(position.status).label }}
                        </span>
                      </td>
                      <td class="timestamp">{{ position.startedAt | relativeTime }}</td>
                      <td class="actions">
                        <button class="tpsl-button" (click)="syncTpSl(position.positionId); $event.stopPropagation()" [title]="t('arbitrageChart.actions.tpslTooltip')">
                          {{ t('arbitrageChart.actions.tpsl') }}
                        </button>
                        <button
                          [class.monitoring-enabled]="position.monitoring?.enabled"
                          [class.monitoring-disabled]="!position.monitoring?.enabled"
                          (click)="toggleMonitoring(position); $event.stopPropagation()"
                          [title]="position.monitoring?.enabled ? t('arbitrageChart.actions.monitoringActive') : t('arbitrageChart.actions.monitoringDisabled')">
                          {{ position.monitoring?.enabled ? 'üëÅÔ∏è ' + t('arbitrageChart.actions.monitoringOn') : 'üëÅÔ∏è ' + t('arbitrageChart.actions.monitoringOff') }}
                        </button>
                        <button class="stop-button" (click)="stopPosition(position.positionId); $event.stopPropagation()">
                          {{ t('arbitrageChart.actions.stop') }}
                        </button>
                      </td>
                    </tr>

                    <!-- Expanded Details Row -->
                    @if (isRowExpanded(position.positionId)) {
                      <tr class="expanded-row">
                        <td colspan="7">
                          <div class="position-details">
                            <table class="details-table">
                              <thead>
                                <tr>
                                  <th>{{ t('arbitrageChart.details.metric') }}</th>
                                  <th>{{ t('arbitrageChart.details.primary') }} ({{ position.primary.exchange }})</th>
                                  <th>{{ t('arbitrageChart.details.hedge') }} ({{ position.hedge.exchange }})</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td class="metric-label">{{ t('arbitrageChart.details.entryPrice') }}</td>
                                  <td class="metric-value">{{ position.primary.entryPrice ? (position.primary.entryPrice | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                  <td class="metric-value">{{ position.hedge.entryPrice ? (position.hedge.entryPrice | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                </tr>
                                @if (position.primary.unrealizedProfit !== undefined || position.hedge.unrealizedProfit !== undefined) {
                                  <tr>
                                    <td class="metric-label">{{ t('arbitrageChart.details.unrealizedPnl') }}</td>
                                    <td class="metric-value"
                                        [class.positive]="(position.primary.unrealizedProfit || 0) > 0"
                                        [class.negative]="(position.primary.unrealizedProfit || 0) < 0">
                                      {{ formatCurrency(position.primary.unrealizedProfit) }} USDT
                                    </td>
                                    <td class="metric-value"
                                        [class.positive]="(position.hedge.unrealizedProfit || 0) > 0"
                                        [class.negative]="(position.hedge.unrealizedProfit || 0) < 0">
                                      {{ formatCurrency(position.hedge.unrealizedProfit) }} USDT
                                    </td>
                                  </tr>
                                }
                                @if (position.primary.realizedProfit !== undefined || position.hedge.realizedProfit !== undefined) {
                                  <tr>
                                    <td class="metric-label">{{ t('arbitrageChart.details.realizedPnl') }}</td>
                                    <td class="metric-value"
                                        [class.positive]="(position.primary.realizedProfit || 0) > 0"
                                        [class.negative]="(position.primary.realizedProfit || 0) < 0">
                                      {{ formatCurrency(position.primary.realizedProfit) }} USDT
                                    </td>
                                    <td class="metric-value"
                                        [class.positive]="(position.hedge.realizedProfit || 0) > 0"
                                        [class.negative]="(position.hedge.realizedProfit || 0) < 0">
                                      {{ formatCurrency(position.hedge.realizedProfit) }} USDT
                                    </td>
                                  </tr>
                                }
                                @if (position.primary.liquidationPrice || position.hedge.liquidationPrice) {
                                  <tr>
                                    <td class="metric-label">{{ t('arbitrageChart.details.liquidationPrice') }}</td>
                                    <td class="metric-value">{{ position.primary.liquidationPrice ? (position.primary.liquidationPrice | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                    <td class="metric-value">{{ position.hedge.liquidationPrice ? (position.hedge.liquidationPrice | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                  </tr>
                                }
                                @if (position.primary.proximityRatio !== undefined && position.primary.proximityRatio !== null || position.hedge.proximityRatio !== undefined && position.hedge.proximityRatio !== null) {
                                  <tr>
                                    <td class="metric-label">{{ t('arbitrageChart.details.liquidationProximity') }}</td>
                                    <td class="metric-value">
                                      @if (position.primary.proximityRatio !== undefined && position.primary.proximityRatio !== null) {
                                        <span class="proximity-value"
                                              [class.proximity-safe]="position.primary.proximityRatio < 0.7"
                                              [class.proximity-warning]="position.primary.proximityRatio >= 0.7 && position.primary.proximityRatio < 0.9"
                                              [class.proximity-danger]="position.primary.proximityRatio >= 0.9">
                                          {{ (position.primary.proximityRatio * 100) | number:'1.1-1' }}%
                                          @if (position.primary.inDanger) {
                                            <span class="danger-badge">{{ t('arbitrageChart.details.danger') }}</span>
                                          }
                                        </span>
                                      } @else {
                                        {{ t('arbitrageChart.details.notAvailable') }}
                                      }
                                    </td>
                                    <td class="metric-value">
                                      @if (position.hedge.proximityRatio !== undefined && position.hedge.proximityRatio !== null) {
                                        <span class="proximity-value"
                                              [class.proximity-safe]="position.hedge.proximityRatio < 0.7"
                                              [class.proximity-warning]="position.hedge.proximityRatio >= 0.7 && position.hedge.proximityRatio < 0.9"
                                              [class.proximity-danger]="position.hedge.proximityRatio >= 0.9">
                                          {{ (position.hedge.proximityRatio * 100) | number:'1.1-1' }}%
                                          @if (position.hedge.inDanger) {
                                            <span class="danger-badge">{{ t('arbitrageChart.details.danger') }}</span>
                                          }
                                        </span>
                                      } @else {
                                        {{ t('arbitrageChart.details.notAvailable') }}
                                      }
                                    </td>
                                  </tr>
                                }
                                @if (position.primary.stopLoss || position.hedge.stopLoss) {
                                  <tr>
                                    <td class="metric-label">{{ t('arbitrageChart.details.stopLoss') }}</td>
                                    <td class="metric-value">{{ position.primary.stopLoss ? (position.primary.stopLoss | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                    <td class="metric-value">{{ position.hedge.stopLoss ? (position.hedge.stopLoss | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                  </tr>
                                }
                                @if (position.primary.takeProfit || position.hedge.takeProfit) {
                                  <tr>
                                    <td class="metric-label">{{ t('arbitrageChart.details.takeProfit') }}</td>
                                    <td class="metric-value">{{ position.primary.takeProfit ? (position.primary.takeProfit | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                    <td class="metric-value">{{ position.hedge.takeProfit ? (position.hedge.takeProfit | number:'1.2-6') : t('arbitrageChart.details.notAvailable') }}</td>
                                  </tr>
                                }
                                <tr>
                                  <td class="metric-label">{{ t('arbitrageChart.details.lastFundingPaid') }}</td>
                                  <td class="metric-value">{{ formatCurrency(position.primary.lastFundingPaid) }} USDT</td>
                                  <td class="metric-value">{{ formatCurrency(position.hedge.lastFundingPaid) }} USDT</td>
                                </tr>
                                <tr>
                                  <td class="metric-label">{{ t('arbitrageChart.details.totalFundingEarned') }}</td>
                                  <td class="metric-value positive">{{ formatCurrency(position.primary.totalFundingEarned) }} USDT</td>
                                  <td class="metric-value positive">{{ formatCurrency(position.hedge.totalFundingEarned) }} USDT</td>
                                </tr>
                                <tr>
                                  <td class="metric-label">{{ t('arbitrageChart.details.entryFees') }}</td>
                                  <td class="metric-value negative">{{ formatCurrency(position.primary.tradingFees) }} USDT</td>
                                  <td class="metric-value negative">{{ formatCurrency(position.hedge.tradingFees) }} USDT</td>
                                </tr>
                                <tr class="summary-row">
                                  <td class="metric-label">{{ t('arbitrageChart.details.grossProfit') }}</td>
                                  <td colspan="2" class="metric-value gross-profit">{{ formatCurrency(position.grossProfit) }} USDT</td>
                                </tr>
                                <tr class="summary-row">
                                  <td class="metric-label">{{ t('arbitrageChart.details.netProfit') }}</td>
                                  <td colspan="2" class="metric-value net-profit" [class.positive]="(position.netProfit || 0) > 0" [class.negative]="(position.netProfit || 0) < 0">
                                    {{ formatCurrency(position.netProfit) }} USDT
                                  </td>
                                </tr>
                              </tbody>
                            </table>

                            <!-- Error Message Section for ERROR status -->
                            @if (position.status === 'ERROR' && position.errorMessage) {
                              <div class="error-message-section">
                                <div class="error-header">
                                  <span class="error-icon">‚ö†Ô∏è</span>
                                  <span class="error-title">{{ t('arbitrageChart.error.title') }}</span>
                                </div>
                                <div class="error-content">
                                  <div class="error-details">
                                    <h4>{{ t('arbitrageChart.error.details') }}</h4>
                                    <p class="error-text">{{ position.errorMessage }}</p>
                                  </div>

                                  <div class="troubleshooting-section">
                                    <h4>{{ t('arbitrageChart.error.howToFix') }}</h4>
                                    <ol class="fix-steps">
                                      <li>
                                        <strong>{{ t('arbitrageChart.error.checkConnectivity') }}</strong>
                                        <ul>
                                          <li>{{ t('arbitrageChart.error.verifyInternet') }}</li>
                                          <li>{{ t('arbitrageChart.error.checkApis') }} {{ position.primary.exchange }} {{ t('arbitrageChart.error.checkApis') }} {{ position.hedge.exchange }} {{ t('arbitrageChart.error.checkApisOperational') }}</li>
                                          <li>{{ t('arbitrageChart.error.lookForErrors') }}</li>
                                        </ul>
                                      </li>
                                      <li>
                                        <strong>{{ t('arbitrageChart.error.verifyCredentials') }}</strong>
                                        <ul>
                                          <li>{{ t('arbitrageChart.error.goToProfile') }}</li>
                                          <li>{{ t('arbitrageChart.error.testConnection') }}</li>
                                          <li>{{ t('arbitrageChart.error.checkPermissions') }}</li>
                                        </ul>
                                      </li>
                                      <li>
                                        <strong>{{ t('arbitrageChart.error.checkStatus') }}</strong>
                                        <ul>
                                          <li>{{ t('arbitrageChart.error.visitWebsites') }}</li>
                                          <li>{{ t('arbitrageChart.error.checkRateLimits') }}</li>
                                        </ul>
                                      </li>
                                    </ol>
                                  </div>

                                  <div class="error-actions">
                                    <div class="status-info">
                                      <p class="warning-text">
                                        ‚ö†Ô∏è <strong>{{ t('arbitrageChart.error.partiallyFilled') }}</strong> {{ t('arbitrageChart.error.partiallyFilledMessage') }}
                                      </p>
                                    </div>
                                    <button class="close-error-button" (click)="stopPosition(position.positionId); $event.stopPropagation()">
                                      {{ t('arbitrageChart.error.closePosition') }}
                                    </button>
                                    <p class="error-help-text">
                                      {{ t('arbitrageChart.error.closePositionHelp') }}
                                    </p>
                                  </div>
                                </div>
                              </div>
                            }
                          </div>
                        </td>
                      </tr>
                    }
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>

      <!-- Right Side: Info Panel (1/3 width) -->
      <div id="info-panel" class="info-panel">
        <!-- Active Signal Monitoring Status -->
        @if (activeSignalConfig()) {
          <div id="signal-monitor-status" class="signal-monitor-status">
            <div class="status-header">
              <div class="header-left">
                <span class="status-icon">üéØ</span>
                <h3>–ú–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –°–∏–≥–Ω–∞–ª—É</h3>
              </div>
              <div class="header-right">
                <button
                  class="edit-signal-button"
                  (click)="editSignalConfig()"
                  title="–†–µ–¥–∞–≥—É–≤–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä–∏ —Å–∏–≥–Ω–∞–ª—É">
                  ‚úèÔ∏è
                </button>
                <span class="status-badge active">–ê–ö–¢–ò–í–ù–ò–ô</span>
              </div>
            </div>

            <div class="signal-config">
              <div class="config-row">
                <span class="config-label">–ö—ñ–ª—å–∫—ñ—Å—Ç—å:</span>
                <span class="config-value">{{ activeSignalConfig()!.quantity }} &#64; {{ activeSignalConfig()!.leverage }}x</span>
              </div>
            </div>

            @if (signalPriceUpdate()) {
              <div class="signal-conditions">
                <h4>–£–º–æ–≤–∏ –°–ø—Ä–∞—Ü—é–≤–∞–Ω–Ω—è</h4>

                <!-- Price Spread Condition -->
                <div class="condition-item">
                  <div class="condition-header">
                    <span class="condition-label">Price Spread</span>
                    <span class="condition-status" [class.met]="signalPriceUpdate()!.priceConditionMet" [class.not-met]="!signalPriceUpdate()!.priceConditionMet">
                      {{ signalPriceUpdate()!.priceConditionMet ? '‚úì –í–∏–∫–æ–Ω–∞–Ω–æ' : '‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è' }}
                    </span>
                  </div>
                  <div class="condition-progress">
                    <div class="progress-bar">
                      <div class="progress-fill"
                           [style.width.%]="getPriceSpreadProgress()"
                           [class.met]="signalPriceUpdate()!.priceConditionMet"></div>
                    </div>
                    <div class="progress-text">
                      <span class="current-value">${{ signalPriceUpdate()!.priceSpreadUsdt.toFixed(2) }} / {{ signalPriceUpdate()!.priceSpreadPercent.toFixed(4) }}%</span>
                      <span class="target-value">/ {{ activeSignalConfig()!.minPriceSpreadPercent }}%</span>
                    </div>
                  </div>
                  <div class="condition-prices">
                    <span class="price-item">{{ activeSignalConfig()!.primaryExchange }}: ${{ signalPriceUpdate()!.primaryPrice.toFixed(6) }}</span>
                    <span class="price-item">{{ activeSignalConfig()!.hedgeExchange }}: ${{ signalPriceUpdate()!.hedgePrice.toFixed(6) }}</span>
                  </div>
                </div>

                <!-- Funding Spread Condition (if combined strategy) -->
                @if (activeSignalConfig()!.strategy === 'combined' && activeSignalConfig()!.minFundingSpreadPercent !== undefined && signalPriceUpdate()!.fundingSpreadPercent !== undefined) {
                  <div class="condition-item">
                    <div class="condition-header">
                      <span class="condition-label">Funding Spread</span>
                      <span class="condition-status" [class.met]="signalPriceUpdate()!.fundingConditionMet" [class.not-met]="!signalPriceUpdate()!.fundingConditionMet">
                        {{ signalPriceUpdate()!.fundingConditionMet ? '‚úì –í–∏–∫–æ–Ω–∞–Ω–æ' : '‚è≥ –û—á—ñ–∫—É–≤–∞–Ω–Ω—è' }}
                      </span>
                    </div>
                    <div class="condition-progress">
                      <div class="progress-bar">
                        <div class="progress-fill"
                             [style.width.%]="getFundingSpreadProgress()"
                             [class.met]="signalPriceUpdate()!.fundingConditionMet"></div>
                      </div>
                      <div class="progress-text">
                        <span class="current-value">{{ signalPriceUpdate()!.fundingSpreadPercent!.toFixed(4) }}%</span>
                        <span class="target-value">/ {{ activeSignalConfig()!.minFundingSpreadPercent }}%</span>
                      </div>
                    </div>
                  </div>
                }
              </div>
            } @else {
              <div class="signal-waiting">
                <span class="waiting-icon">‚è≥</span>
                <span class="waiting-text">–û—á—ñ–∫—É–≤–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö...</span>
              </div>
            }
          </div>
        }

        <div id="exchange-info-grid-top" class="exchange-info-grid">
          <div id="primary-exchange-info" class="exchange-column primary-column">
            <button
                class="column-header primary"
                (click)="openExchange(primaryExchange())"
                type="button"
                title="Open {{ primaryExchange() }} in new window">
              <div class="header-content-wrapper">
                <h3>{{ primaryExchange() }}</h3>
                @if (strategy() === 'spot_futures') {
                  <span class="market-type-badge spot">
                    <span class="badge-icon">üõí</span>
                    <span class="badge-text">SPOT</span>
                  </span>
                }
              </div>
            </button>

            <div class="info-items">
              @if (strategy() === 'combined' || strategy() === 'price_only' || strategy() === 'funding_only') {
                <div class="info-item">
                  <span class="info-label">{{ t('arbitrageChart.exchange.funding') }}</span>
                  <span class="info-value text-sm"
                        [class.positive]="parseFundingRate(primaryData().fundingRate) > 0"
                        [class.negative]="parseFundingRate(primaryData().fundingRate) < 0">
                    {{ primaryFormattedFunding() }}
                  </span>
                </div>
              }

              <!-- Account Balance -->
              <div class="info-item balance-item">
                <span class="info-label">{{ t('arbitrageChart.exchange.accountBalance') }}</span>
                @if (primaryBalance().loading) {
                  <span class="info-value loading-balance">
                    <span class="balance-spinner"></span>
                    {{ t('arbitrageChart.exchange.loading') }}
                  </span>
                } @else {
                  <div class="balance-values">
                    <div class="balance-row">
                      <span class="balance-label">{{ t('arbitrageChart.exchange.total') }}</span>
                      <span class="balance-value">{{ primaryBalance().totalBalance }} USDT</span>
                    </div>
                    <div class="balance-row">
                      <span class="balance-label">{{ t('arbitrageChart.exchange.available') }}</span>
                      <span class="balance-value available">{{ primaryBalance().availableBalance }} USDT</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>
          <div class="sync-lock-container"></div>
          <div id="hedge-exchange-info" class="exchange-column hedge-column">
            <button
                class="column-header hedge"
                (click)="openExchange(hedgeExchange())"
                type="button"
                title="Open {{ hedgeExchange() }} in new window">
              <div class="header-content-wrapper">
                <h3>{{ hedgeExchange() }}</h3>
                @if (strategy() === 'spot_futures') {
                  <span class="market-type-badge futures">
                    <span class="badge-icon">üìà</span>
                    <span class="badge-text">FUTURES</span>
                  </span>
                }
              </div>
            </button>

            <div class="info-items">
              <div class="info-item">
                <span class="info-label">{{ t('arbitrageChart.exchange.funding') }}</span>
                <span class="info-value text-sm"
                      [class.positive]="parseFundingRate(hedgeData().fundingRate) > 0"
                      [class.negative]="parseFundingRate(hedgeData().fundingRate) < 0">
                  {{ hedgeFormattedFunding() }}
                </span>
              </div>

              <!-- Account Balance -->
              <div class="info-item balance-item">
                <span class="info-label">{{ t('arbitrageChart.exchange.accountBalance') }}</span>
                @if (hedgeBalance().loading) {
                  <span class="info-value loading-balance">
                    <span class="balance-spinner"></span>
                    {{ t('arbitrageChart.exchange.loading') }}
                  </span>
                } @else {
                  <div class="balance-values">
                    <div class="balance-row">
                      <span class="balance-label">{{ t('arbitrageChart.exchange.total') }}</span>
                      <span class="balance-value">{{ hedgeBalance().totalBalance }} USDT</span>
                    </div>
                    <div class="balance-row">
                      <span class="balance-label">{{ t('arbitrageChart.exchange.available') }}</span>
                      <span class="balance-value available">{{ hedgeBalance().availableBalance }} USDT</span>
                    </div>
                  </div>
                }
              </div>
            </div>
          </div>

        </div>

        <!-- Profit Calculator Panel -->
        <app-arbitrage-profit-calculator
          id="profit-calculator"
          [strategy]="strategy()"
          [primaryExchange]="primaryExchange()"
          [hedgeExchange]="hedgeExchange()"
          [primaryPrice]="primaryData().price || 0"
          [hedgePrice]="hedgeData().price || 0"
          [primaryFundingRate]="parseFundingRate(primaryData().fundingRate || '0')"
          [hedgeFundingRate]="parseFundingRate(hedgeData().fundingRate || '0')"
          [fundingInterval]="getMaxFundingInterval()"
          [positionSize]="primaryAmount()"
          [leverage]="primaryLeverage()"
        />

        <div id="exchange-info-grid-bottom" class="exchange-info-grid">
          <!-- Primary Exchange Column -->
          <div id="primary-order-column" class="exchange-column primary-column">


            <!-- Order Form for Primary Exchange -->
            <form id="primary-order-form" [formGroup]="primaryOrderForm" class="order-form">
             <!-- <div class="form-header">
                <h4>Order Parameters</h4>
              </div>-->

              <!-- SPOT MARKET: No side selector, no leverage -->
              @if (strategy() === 'spot_futures') {
                <div class="form-field spot-market-info">
                  <div class="info-box">
                    <span class="info-icon">‚ÑπÔ∏è</span>
                    <span class="info-text">{{ t('arbitrageChart.form.spotMarketInfo') }}</span>
                  </div>
                </div>
              }

              <!-- FUTURES MARKET: Show side selector and leverage -->
              @if (strategy() === 'combined' || strategy() === 'price_only' || strategy() === 'funding_only') {
                <div class="form-field">
                  <label class="form-label">{{ t('arbitrageChart.form.side') }}</label>
                  <div class="side-selector">
                    <label class="side-option">
                      <input type="radio" formControlName="side" value="long">
                      <span class="side-label long">{{ t('arbitrageChart.form.long') }}</span>
                    </label>
                    <label class="side-option">
                      <input type="radio" formControlName="side" value="short">
                      <span class="side-label short">{{ t('arbitrageChart.form.short') }}</span>
                    </label>
                  </div>
                </div>

                <div class="form-field">
                  <label class="form-label">{{ t('arbitrageChart.form.leverage') }}</label>
                  <input
                    type="number"
                    formControlName="leverage"
                    class="form-input"
                    placeholder="10"
                    min="1"
                    max="125"
                    step="1">
                </div>
              }

              <div class="form-field">
                @if (primarySymbolInfo()) {
                  <label class="form-label">Quantity (min: {{ primarySymbolInfo()!.minOrderQty }}{{ getCoinSymbol() }}/order)</label>
                } @else {
                  <label class="form-label">Quantity (min: 0.001{{ getCoinSymbol() }})</label>
                }
                <div class="quantity-input-wrapper" [class.error]="!primaryValidation().valid && primaryOrderForm.get('quantity')?.touched">
                  <input
                    type="number"
                    formControlName="quantity"
                    class="form-input quantity-input"
                    placeholder="0.001"
                    min="0.001"
                    step="0.001">
                  <div class="quantity-unit-dropdown">
                    <button
                      type="button"
                      class="quantity-unit-trigger"
                      (click)="togglePrimaryQuantityDropdown(); $event.stopPropagation()">
                      <span class="unit-text">{{ primaryQuantityUnit() === 'coin' ? getCoinSymbol() : 'USDT' }}</span>
                      <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    @if (primaryDropdownOpen()) {
                      <div class="quantity-unit-options">
                        <button
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="primaryQuantityUnit() === 'coin'"
                          (click)="setPrimaryQuantityUnit('coin')">
                          {{ getCoinSymbol() }}
                        </button>
                        <button
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="primaryQuantityUnit() === 'usdt'"
                          (click)="setPrimaryQuantityUnit('usdt')">
                          USDT
                        </button>
                      </div>
                    }
                  </div>
                </div>
                @if (!primaryValidation().valid && primaryOrderForm.get('quantity')?.touched) {
                  <div class="validation-error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <div class="error-content">
                      <div class="error-text">{{ primaryValidation().error }}</div>
                      @if (primaryValidation().suggestion) {
                        <div class="suggestion-text">üí° {{ primaryValidation().suggestion }}</div>
                      }
                    </div>
                  </div>
                }
              </div>

              @if (strategy() === 'spot_futures') {
                <!-- Simplified graduated entry for SPOT -->
                <div class="form-field">
                  <label class="form-label">{{ t('arbitrageChart.form.parts') }} {{ t('arbitrageChart.form.partsRangeSpot') }}
                    <span class="field-hint">{{ t('arbitrageChart.form.splitBuy') }}</span>
                  </label>
                  <input
                    type="number"
                    formControlName="graduatedParts"
                    class="form-input"
                    placeholder="3"
                    min="1"
                    max="5"
                    step="1">
                </div>

                <div class="form-field">
                  <label class="form-label">{{ t('arbitrageChart.form.delay') }} {{ t('arbitrageChart.form.delayRangeSpot') }}
                    <span class="field-hint">{{ t('arbitrageChart.form.delayBetweenBuys') }}</span>
                  </label>
                  <input
                    type="number"
                    formControlName="graduatedDelayMs"
                    class="form-input"
                    placeholder="1"
                    min="0.1"
                    max="10"
                    step="0.1">
                </div>
              } @else {
                <!-- Full graduated entry for FUTURES -->
                <div class="form-field">
                  <label class="form-label">{{ t('arbitrageChart.form.parts') }} {{ t('arbitrageChart.form.partsRange') }}</label>
                  <input
                    type="number"
                    formControlName="graduatedParts"
                    class="form-input"
                    placeholder="5"
                    min="1"
                    max="20"
                    step="1">
                </div>

                <div class="form-field">
                  <label class="form-label">{{ t('arbitrageChart.form.delay') }} {{ t('arbitrageChart.form.delayRange') }}</label>
                  <input
                    type="number"
                    formControlName="graduatedDelayMs"
                    class="form-input"
                    placeholder="2"
                    min="0.1"
                    max="60"
                    step="0.1">
                </div>
              }
            </form>
          </div>

          <!-- Sync Lock Button -->
          <div class="sync-lock-container">
            @if (strategy() === 'combined' || strategy() === 'price_only' || strategy() === 'funding_only') {
              <button
                type="button"
                class="sync-lock-button"
                [class.locked]="orderParamsLocked()"
                [class.unlocked]="!orderParamsLocked()"
                (click)="toggleOrderParamsLock()"
                [title]="orderParamsLocked() ? t('arbitrageChart.syncLock.locked') : t('arbitrageChart.syncLock.unlocked')">
                @if (orderParamsLocked()) {
                  <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="5" y="11" width="14" height="10" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 10 0v4"></path>
                  </svg>
                } @else {
                  <svg class="lock-icon" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                    <rect x="5" y="11" width="14" height="10" rx="2" ry="2"></rect>
                    <path d="M7 11V7a5 5 0 0 1 9.9-1"></path>
                  </svg>
                }
              </button>
            } @else {
              <div class="sync-lock-disabled" [title]="t('arbitrageChart.syncLock.disabled')">
                <svg class="lock-icon disabled" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2">
                  <rect x="5" y="11" width="14" height="10" rx="2" ry="2"></rect>
                  <line x1="4" y1="4" x2="20" y2="20" stroke-width="2"></line>
                </svg>
              </div>
            }
          </div>

          <!-- Hedge Exchange Column -->
          <div id="hedge-order-column" class="exchange-column hedge-column">
            <!-- Order Form for Hedge Exchange -->
            <form id="hedge-order-form" [formGroup]="hedgeOrderForm" class="order-form">
            <!--  <div class="form-header">
                <h4>Order Parameters</h4>
              </div>-->

              <div class="form-field">
                <label class="form-label">{{ t('arbitrageChart.form.side') }}</label>
                <div class="side-selector">
                  <label class="side-option">
                    <input type="radio" formControlName="side" value="long">
                    <span class="side-label long">{{ t('arbitrageChart.form.long') }}</span>
                  </label>
                  <label class="side-option">
                    <input type="radio" formControlName="side" value="short">
                    <span class="side-label short">{{ t('arbitrageChart.form.short') }}</span>
                  </label>
                </div>
              </div>

              <div class="form-field">
                <label class="form-label">{{ t('arbitrageChart.form.leverage') }}</label>
                <input
                  type="number"
                  formControlName="leverage"
                  class="form-input"
                  placeholder="10"
                  min="1"
                  max="125"
                  step="1">
              </div>

              <div class="form-field">
                @if (hedgeSymbolInfo()) {
                  <label class="form-label">Quantity (min: {{ hedgeSymbolInfo()!.minOrderQty }}{{ getCoinSymbol() }}/order)</label>
                } @else {
                  <label class="form-label">Quantity (min: 0.001{{ getCoinSymbol() }})</label>
                }
                <div class="quantity-input-wrapper" [class.error]="!hedgeValidation().valid && hedgeOrderForm.get('quantity')?.touched">
                  <input
                    type="number"
                    formControlName="quantity"
                    class="form-input quantity-input"
                    placeholder="0.001"
                    min="0.001"
                    step="0.001">
                  <div class="quantity-unit-dropdown">
                    <button
                      type="button"
                      class="quantity-unit-trigger"
                      (click)="toggleHedgeQuantityDropdown(); $event.stopPropagation()">
                      <span class="unit-text">{{ hedgeQuantityUnit() === 'coin' ? getCoinSymbol() : 'USDT' }}</span>
                      <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    @if (hedgeDropdownOpen()) {
                      <div class="quantity-unit-options">
                        <button
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="hedgeQuantityUnit() === 'coin'"
                          (click)="setHedgeQuantityUnit('coin')">
                          {{ getCoinSymbol() }}
                        </button>
                        <button
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="hedgeQuantityUnit() === 'usdt'"
                          (click)="setHedgeQuantityUnit('usdt')">
                          USDT
                        </button>
                      </div>
                    }
                  </div>
                </div>
                @if (!hedgeValidation().valid && hedgeOrderForm.get('quantity')?.touched) {
                  <div class="validation-error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <div class="error-content">
                      <div class="error-text">{{ hedgeValidation().error }}</div>
                      @if (hedgeValidation().suggestion) {
                        <div class="suggestion-text">üí° {{ hedgeValidation().suggestion }}</div>
                      }
                    </div>
                  </div>
                }
              </div>

              <div class="form-field">
                <label class="form-label">{{ t('arbitrageChart.form.parts') }} {{ t('arbitrageChart.form.partsRange') }}</label>
                <input
                  type="number"
                  formControlName="graduatedParts"
                  class="form-input"
                  placeholder="5"
                  min="1"
                  max="20"
                  step="1">
              </div>

              <div class="form-field">
                <label class="form-label">{{ t('arbitrageChart.form.delay') }} {{ t('arbitrageChart.form.delayRange') }}</label>
                <input
                  type="number"
                  formControlName="graduatedDelayMs"
                  class="form-input"
                  placeholder="2"
                  min="0.1"
                  max="60"
                  step="0.1">
              </div>
            </form>
          </div>
        </div>

        <!-- Credentials Warning -->
        @if (credentialsWarning()) {
          <div id="credentials-warning" class="credentials-warning">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <span class="warning-text">{{ credentialsWarning() }}</span>
          </div>
        }

        <!-- START Buttons for Both Exchanges -->
        <div id="start-button-container" class="start-button-container">
          <button
            class="start-arbitrage-button"
            (click)="startArbitragePosition()"
            [disabled]="isSubmittingOrder() || primaryOrderForm.invalid || hedgeOrderForm.invalid || !hasPrimaryCredentials() || !hasHedgeCredentials()">
            @if (isSubmittingOrder()) {
              <span class="button-spinner"></span>
              {{ t('arbitrageChart.buttons.startingPosition') }}
            } @else {
              {{ t('arbitrageChart.buttons.startArbitrage') }}
            }
          </button>

          @if (hasActiveSignal()) {
            <button
              class="stop-signal-button"
              (click)="stopSignal()">
              <i class="icon-stop"></i>
              {{ t('arbitrageChart.buttons.stopSignal') }}
            </button>
          } @else {
            <button
              class="start-signal-button"
              (click)="openSignalConfigModal()"
              [disabled]="isSubmittingOrder() || primaryOrderForm.invalid || hedgeOrderForm.invalid || !hasPrimaryCredentials() || !hasHedgeCredentials()">
              <i class="icon-notifications_active"></i>
              {{ t('arbitrageChart.buttons.startSignal') }}
            </button>
          }
        </div>
      </div>
    </div>
  }
</div>

<!-- Signal Config Modal -->
<app-signal-config-modal
  id="signal-config-modal"
  [open]="showSignalConfigModal()"
  [strategy]="strategy()"
  [symbol]="symbol()"
  [primaryExchange]="primaryExchange()"
  [hedgeExchange]="hedgeExchange()"
  [signalId]="editingSignalId()"
  [initialConfig]="editingSignalConfig()"
  (close)="closeSignalConfigModal()"
  (save)="onSignalConfigSave($event)">
</app-signal-config-modal>
