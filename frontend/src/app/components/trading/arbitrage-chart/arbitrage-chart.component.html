<div class="arbitrage-chart-container">
  <!-- Header -->
  <div class="chart-header">
    <div class="header-content">
      <button class="back-button" (click)="goBack()">
        ‚Üê Back
      </button>
      <h1 class="chart-title">
        {{ symbol() }} Arbitrage Chart
      </h1>
    </div>
  </div>

  <!-- Loading State -->
  @if (loading()) {
    <div class="loading-container">
      <div class="loading-spinner"></div>
      <p>Loading chart data...</p>
    </div>
  } @else {
    <!-- Historical Data Loading Indicator -->
    @if (loadingHistoricalData()) {
      <div class="historical-data-loading">
        <div class="loading-spinner-small"></div>
        <span>Loading historical data...</span>
      </div>
    }
    <!-- Main Content Layout: Chart (2/3) + Info Panel (1/3) -->
    <div class="main-content">
      <!-- Left Side: Chart (2/3 width) -->
      <div class="chart-section">
        <div class="chart-card">
          <div class="chart-card-header">
            <div class="header-left">
              <h2>Real-Time Price Comparison</h2>
              <div class="spread-badge"
                   [class.positive]="fundingSpread() > 0"
                   [class.negative]="fundingSpread() < 0">
                Funding Spread: {{ formatFundingSpread() }}
              </div>
            </div>
            <div class="header-right">
              <button
                class="fit-content-btn"
                (click)="fitContent()"
                title="Fit chart to show all data">
                <span>üìä</span> Fit
              </button>
              <div class="timeframe-selector">
                <button
                  *ngFor="let tf of timeframeOptions"
                  class="timeframe-btn"
                  [class.active]="selectedTimeframe() === tf.value"
                  (click)="changeTimeframe(tf.value)">
                  {{ tf.label }}
                </button>
              </div>
            </div>
          </div>
          <div #chartContainer class="chart-container"></div>
        </div>

        <!-- Active Positions Table -->
        <div class="active-positions-section">
          <div class="section-header">
            <h2>Active Arbitrage Positions</h2>
            <span class="positions-count">{{ activePositions().length }} position(s)</span>
          </div>

          @if (activePositions().length === 0) {
            <div class="no-positions">
              <span class="icon">üìä</span>
              <p>No active arbitrage positions</p>
              <small>Start a position using the form above</small>
            </div>
          } @else {
            <div class="positions-table-container">
              <table class="positions-table">
                <thead>
                  <tr>
                    <th>Position ID</th>
                    <th>Symbol</th>
                    <th>Primary Exchange</th>
                    <th>Hedge Exchange</th>
                    <th>Status</th>
                    <th>Started At</th>
                    <th>Actions</th>
                  </tr>
                </thead>
                <tbody>
                  @for (position of activePositions(); track position.positionId) {
                    <!-- Main Row (clickable) -->
                    <tr class="position-row" [class.expanded]="isRowExpanded(position.positionId)" (click)="toggleRowExpansion(position.positionId)">
                      <td class="position-id">
                        <span class="expand-icon">{{ isRowExpanded(position.positionId) ? '‚ñº' : '‚ñ∂' }}</span>
                        {{ position.positionId }}
                      </td>
                      <td class="symbol">{{ position.symbol }}</td>
                      <td class="exchange">
                        <div class="exchange-cell">
                          <span class="exchange-name">{{ position.primary.exchange }}</span>
                          <span class="side-badge" [class.long]="position.primary.side === 'long'" [class.short]="position.primary.side === 'short'">
                            {{ position.primary.side }}
                          </span>
                          <span class="leverage">{{ position.primary.leverage }}x</span>
                        </div>
                      </td>
                      <td class="exchange">
                        <div class="exchange-cell">
                          <span class="exchange-name">{{ position.hedge.exchange }}</span>
                          <span class="side-badge" [class.long]="position.hedge.side === 'long'" [class.short]="position.hedge.side === 'short'">
                            {{ position.hedge.side }}
                          </span>
                          <span class="leverage">{{ position.hedge.leverage }}x</span>
                        </div>
                      </td>
                      <td class="status">
                        <span class="status-badge active">Active</span>
                      </td>
                      <td class="timestamp">{{ formatTimestamp(position.startedAt) }}</td>
                      <td class="actions">
                        <button class="stop-button" (click)="stopPosition(position.positionId); $event.stopPropagation()">
                          Stop
                        </button>
                      </td>
                    </tr>

                    <!-- Expanded Details Row -->
                    @if (isRowExpanded(position.positionId)) {
                      <tr class="expanded-row">
                        <td colspan="7">
                          <div class="position-details">
                            <table class="details-table">
                              <thead>
                                <tr>
                                  <th>Metric</th>
                                  <th>Primary ({{ position.primary.exchange }})</th>
                                  <th>Hedge ({{ position.hedge.exchange }})</th>
                                </tr>
                              </thead>
                              <tbody>
                                <tr>
                                  <td class="metric-label">Last Funding Paid</td>
                                  <td class="metric-value">{{ formatCurrency(position.primary.lastFundingPaid) }} USDT</td>
                                  <td class="metric-value">{{ formatCurrency(position.hedge.lastFundingPaid) }} USDT</td>
                                </tr>
                                <tr>
                                  <td class="metric-label">Total Funding Earned</td>
                                  <td class="metric-value positive">{{ formatCurrency(position.primary.totalFundingEarned) }} USDT</td>
                                  <td class="metric-value positive">{{ formatCurrency(position.hedge.totalFundingEarned) }} USDT</td>
                                </tr>
                                <tr>
                                  <td class="metric-label">Trading Fees</td>
                                  <td class="metric-value negative">{{ formatCurrency(position.primary.tradingFees) }} USDT</td>
                                  <td class="metric-value negative">{{ formatCurrency(position.hedge.tradingFees) }} USDT</td>
                                </tr>
                                <tr class="summary-row">
                                  <td class="metric-label">Gross Profit</td>
                                  <td colspan="2" class="metric-value gross-profit">{{ formatCurrency(position.grossProfit) }} USDT</td>
                                </tr>
                                <tr class="summary-row">
                                  <td class="metric-label">Net Profit</td>
                                  <td colspan="2" class="metric-value net-profit" [class.positive]="(position.netProfit || 0) > 0" [class.negative]="(position.netProfit || 0) < 0">
                                    {{ formatCurrency(position.netProfit) }} USDT
                                  </td>
                                </tr>
                              </tbody>
                            </table>
                          </div>
                        </td>
                      </tr>
                    }
                  }
                </tbody>
              </table>
            </div>
          }
        </div>
      </div>

      <!-- Right Side: Info Panel (1/3 width) -->
      <div class="info-panel">
        <div class="exchange-info-grid">
          <!-- Primary Exchange Column -->
          <div class="exchange-column primary-column">
            <button
              class="column-header primary"
              (click)="openExchange(primaryExchange())"
              type="button"
              title="Open {{ primaryExchange() }} in new window">
              <h3>{{ primaryExchange() }}</h3>
              <div class="exchange-label">Primary Exchange</div>
            </button>

            <div class="info-items">
              <div class="info-item">
                <span class="info-label">Funding</span>
                <span class="info-value text-sm"
                      [class.positive]="parseFloat(primaryData().fundingRate) > 0"
                      [class.negative]="parseFloat(primaryData().fundingRate) < 0">
                  {{ formatFundingInfo(primaryData().fundingRate, primaryData().nextFundingTime, primaryData().fundingInterval) }}
                </span>
              </div>

              <!-- Account Balance -->
              <div class="info-item balance-item">
                <span class="info-label">Account Balance</span>
                @if (primaryBalance().loading) {
                  <span class="info-value loading-balance">
                    <span class="balance-spinner"></span>
                    Loading...
                  </span>
                } @else {
                  <div class="balance-values">
                    <div class="balance-row">
                      <span class="balance-label">Total:</span>
                      <span class="balance-value">{{ primaryBalance().totalBalance }} USDT</span>
                    </div>
                    <div class="balance-row">
                      <span class="balance-label">Available:</span>
                      <span class="balance-value available">{{ primaryBalance().availableBalance }} USDT</span>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Order Form for Primary Exchange -->
            <form [formGroup]="primaryOrderForm" class="order-form">
              <div class="form-header">
                <h4>Order Parameters</h4>
              </div>

              <div class="form-field">
                <label class="form-label">Side</label>
                <div class="side-selector">
                  <label class="side-option">
                    <input type="radio" formControlName="side" value="long">
                    <span class="side-label long">Long</span>
                  </label>
                  <label class="side-option">
                    <input type="radio" formControlName="side" value="short">
                    <span class="side-label short">Short</span>
                  </label>
                </div>
              </div>

              <div class="form-field">
                <label class="form-label">Leverage</label>
                <input
                  type="number"
                  formControlName="leverage"
                  class="form-input"
                  placeholder="10"
                  min="1"
                  max="125"
                  step="1">
                <span class="form-hint">1x - 125x</span>
              </div>

              <div class="form-field">
                <label class="form-label">Quantity ({{ primaryQuantityUnit() === 'coin' ? getCoinSymbol() : 'USDT' }})</label>
                <div class="quantity-input-wrapper" [class.error]="!primaryValidation().valid && primaryOrderForm.get('quantity')?.touched">
                  <input
                    type="number"
                    formControlName="quantity"
                    class="form-input quantity-input"
                    placeholder="0.001"
                    min="0.001"
                    step="0.001">
                  <div class="quantity-unit-dropdown">
                    <button 
                      type="button"
                      class="quantity-unit-trigger"
                      (click)="togglePrimaryQuantityDropdown(); $event.stopPropagation()">
                      <span class="unit-text">{{ primaryQuantityUnit() === 'coin' ? getCoinSymbol() : 'USDT' }}</span>
                      <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    @if (primaryDropdownOpen()) {
                      <div class="quantity-unit-options">
                        <button 
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="primaryQuantityUnit() === 'coin'"
                          (click)="setPrimaryQuantityUnit('coin')">
                          {{ getCoinSymbol() }}
                        </button>
                        <button 
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="primaryQuantityUnit() === 'usdt'"
                          (click)="setPrimaryQuantityUnit('usdt')">
                          USDT
                        </button>
                      </div>
                    }
                  </div>
                </div>
                @if (primarySymbolInfo()) {
                  <span class="form-hint">Min: {{ primarySymbolInfo()!.minOrderQty }} {{ getCoinSymbol() }} per order</span>
                } @else {
                  <span class="form-hint">Min: 0.001 {{ getCoinSymbol() }}</span>
                }
                @if (!primaryValidation().valid && primaryOrderForm.get('quantity')?.touched) {
                  <div class="validation-error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span class="error-text">{{ primaryValidation().error }}</span>
                  </div>
                }
              </div>

              <div class="form-field">
                <label class="form-label">Graduated Entry Parts</label>
                <input
                  type="number"
                  formControlName="graduatedParts"
                  class="form-input"
                  placeholder="5"
                  min="1"
                  max="20"
                  step="1">
                <span class="form-hint">Split order into 1-20 parts</span>
              </div>

              <div class="form-field">
                <label class="form-label">Delay Between Parts (sec)</label>
                <input
                  type="number"
                  formControlName="graduatedDelayMs"
                  class="form-input"
                  placeholder="2"
                  min="0.1"
                  max="60"
                  step="0.1">
                <span class="form-hint">0.1s - 60s (1 minute)</span>
              </div>
            </form>
          </div>

          <!-- Hedge Exchange Column -->
          <div class="exchange-column hedge-column">
            <button
              class="column-header hedge"
              (click)="openExchange(hedgeExchange())"
              type="button"
              title="Open {{ hedgeExchange() }} in new window">
              <h3>{{ hedgeExchange() }}</h3>
              <div class="exchange-label">Hedge Exchange</div>
            </button>

            <div class="info-items">
              <div class="info-item">
                <span class="info-label">Funding</span>
                <span class="info-value text-sm"
                      [class.positive]="parseFloat(hedgeData().fundingRate) > 0"
                      [class.negative]="parseFloat(hedgeData().fundingRate) < 0">
                  {{ formatFundingInfo(hedgeData().fundingRate, hedgeData().nextFundingTime, hedgeData().fundingInterval) }}
                </span>
              </div>

              <!-- Account Balance -->
              <div class="info-item balance-item">
                <span class="info-label">Account Balance</span>
                @if (hedgeBalance().loading) {
                  <span class="info-value loading-balance">
                    <span class="balance-spinner"></span>
                    Loading...
                  </span>
                } @else {
                  <div class="balance-values">
                    <div class="balance-row">
                      <span class="balance-label">Total:</span>
                      <span class="balance-value">{{ hedgeBalance().totalBalance }} USDT</span>
                    </div>
                    <div class="balance-row">
                      <span class="balance-label">Available:</span>
                      <span class="balance-value available">{{ hedgeBalance().availableBalance }} USDT</span>
                    </div>
                  </div>
                }
              </div>
            </div>

            <!-- Order Form for Hedge Exchange -->
            <form [formGroup]="hedgeOrderForm" class="order-form">
              <div class="form-header">
                <h4>Order Parameters</h4>
              </div>

              <div class="form-field">
                <label class="form-label">Side</label>
                <div class="side-selector">
                  <label class="side-option">
                    <input type="radio" formControlName="side" value="long">
                    <span class="side-label long">Long</span>
                  </label>
                  <label class="side-option">
                    <input type="radio" formControlName="side" value="short">
                    <span class="side-label short">Short</span>
                  </label>
                </div>
              </div>

              <div class="form-field">
                <label class="form-label">Leverage</label>
                <input
                  type="number"
                  formControlName="leverage"
                  class="form-input"
                  placeholder="10"
                  min="1"
                  max="125"
                  step="1">
                <span class="form-hint">1x - 125x</span>
              </div>

              <div class="form-field">
                <label class="form-label">Quantity ({{ hedgeQuantityUnit() === 'coin' ? getCoinSymbol() : 'USDT' }})</label>
                <div class="quantity-input-wrapper" [class.error]="!hedgeValidation().valid && hedgeOrderForm.get('quantity')?.touched">
                  <input
                    type="number"
                    formControlName="quantity"
                    class="form-input quantity-input"
                    placeholder="0.001"
                    min="0.001"
                    step="0.001">
                  <div class="quantity-unit-dropdown">
                    <button 
                      type="button"
                      class="quantity-unit-trigger"
                      (click)="toggleHedgeQuantityDropdown(); $event.stopPropagation()">
                      <span class="unit-text">{{ hedgeQuantityUnit() === 'coin' ? getCoinSymbol() : 'USDT' }}</span>
                      <span class="dropdown-arrow">‚ñº</span>
                    </button>
                    @if (hedgeDropdownOpen()) {
                      <div class="quantity-unit-options">
                        <button 
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="hedgeQuantityUnit() === 'coin'"
                          (click)="setHedgeQuantityUnit('coin')">
                          {{ getCoinSymbol() }}
                        </button>
                        <button 
                          type="button"
                          class="quantity-unit-option"
                          [class.active]="hedgeQuantityUnit() === 'usdt'"
                          (click)="setHedgeQuantityUnit('usdt')">
                          USDT
                        </button>
                      </div>
                    }
                  </div>
                </div>
                @if (hedgeSymbolInfo()) {
                  <span class="form-hint">Min: {{ hedgeSymbolInfo()!.minOrderQty }} {{ getCoinSymbol() }} per order</span>
                } @else {
                  <span class="form-hint">Min: 0.001 {{ getCoinSymbol() }}</span>
                }
                @if (!hedgeValidation().valid && hedgeOrderForm.get('quantity')?.touched) {
                  <div class="validation-error">
                    <span class="error-icon">‚ö†Ô∏è</span>
                    <span class="error-text">{{ hedgeValidation().error }}</span>
                  </div>
                }
              </div>

              <div class="form-field">
                <label class="form-label">Graduated Entry Parts</label>
                <input
                  type="number"
                  formControlName="graduatedParts"
                  class="form-input"
                  placeholder="5"
                  min="1"
                  max="20"
                  step="1">
                <span class="form-hint">Split order into 1-20 parts</span>
              </div>

              <div class="form-field">
                <label class="form-label">Delay Between Parts (sec)</label>
                <input
                  type="number"
                  formControlName="graduatedDelayMs"
                  class="form-input"
                  placeholder="2"
                  min="0.1"
                  max="60"
                  step="0.1">
                <span class="form-hint">0.1s - 60s (1 minute)</span>
              </div>
            </form>
          </div>
        </div>

        <!-- Credentials Warning -->
        @if (credentialsWarning()) {
          <div class="credentials-warning">
            <span class="warning-icon">‚ö†Ô∏è</span>
            <span class="warning-text">{{ credentialsWarning() }}</span>
          </div>
        }

        <!-- START Button for Both Exchanges -->
        <div class="start-button-container">
          <button
            class="start-arbitrage-button"
            (click)="startArbitragePosition()"
            [disabled]="isSubmittingOrder() || primaryOrderForm.invalid || hedgeOrderForm.invalid || !hasPrimaryCredentials() || !hasHedgeCredentials()">
            @if (isSubmittingOrder()) {
              <span class="button-spinner"></span>
              Starting Position...
            } @else {
              START ARBITRAGE
            }
          </button>
        </div>
      </div>
    </div>
  }
</div>
