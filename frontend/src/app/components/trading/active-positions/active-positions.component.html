<!-- Active Positions Component -->
<div class="active-positions-section">
  @if (enhancedPositions().length === 0) {
    <div class="empty-state">
      <p>{{ t('arbitrage.noActivePositions') }}</p>
    </div>
  } @else {
    <div class="positions-table-container">
      <table class="positions-table">
        <thead>
          <tr>
            <th>{{ t('arbitrage.positionId') }}</th>
            <th>{{ t('arbitrage.symbol') }}</th>
            <th>{{ t('arbitrage.primary') }}</th>
            <th>{{ t('arbitrage.hedge') }}</th>
            <th>{{ t('arbitrage.status') }}</th>
            <th>{{ t('arbitrage.startedAt') }}</th>
            <th>{{ t('arbitrage.actions') }}</th>
          </tr>
        </thead>
        <tbody>
          @for (position of enhancedPositions(); track position.positionId) {
            <tr>
              <td class="position-id-cell">
                <button
                  class="expand-btn"
                  (click)="toggleRowExpansion(position.positionId)"
                  [attr.aria-expanded]="isRowExpanded(position.positionId)">
                  {{ isRowExpanded(position.positionId) ? '‚ñº' : '‚ñ∂' }}
                </button>
                <span class="position-id-text">{{ position.positionId.slice(0, 8) }}...</span>
              </td>
              <td class="symbol-cell">
                <strong>{{ position.symbol }}</strong>
              </td>
              <td class="exchange-cell">
                <div class="exchange-info">
                  <span class="exchange-name">{{ position.primary.exchange }}</span>
                  <span class="side-badge" [class.side-long]="position.primary.side.toUpperCase() === 'LONG'" [class.side-short]="position.primary.side.toUpperCase() === 'SHORT'">
                    {{ position.primary.side.toUpperCase() }}
                  </span>
                  <span class="leverage-text">{{ position.primary.leverage }}x</span>
                </div>
              </td>
              <td class="exchange-cell">
                <div class="exchange-info">
                  <span class="exchange-name">{{ position.hedge.exchange }}</span>
                  <span class="side-badge" [class.side-long]="position.hedge.side.toUpperCase() === 'LONG'" [class.side-short]="position.hedge.side.toUpperCase() === 'SHORT'">
                    {{ position.hedge.side.toUpperCase() }}
                  </span>
                  <span class="leverage-text">{{ position.hedge.leverage }}x</span>
                </div>
              </td>
              <td class="status-cell">
                <span
                  class="status-badge"
                  [class]="getStatusBadge(position.status).class">
                  {{ getStatusBadge(position.status).label }}
                </span>
                @if (position.errorMessage) {
                  <span class="error-icon" [title]="position.errorMessage">‚ö†Ô∏è</span>
                }
              </td>
              <td class="time-cell">
                {{ position.startedAt | relativeTime }}
              </td>
              <td class="actions-cell">
                @if (position.status.toUpperCase() === 'ACTIVE') {
                  <button
                    class="action-btn sync-btn"
                    (click)="syncTpSlClick.emit(position.positionId)"
                    title="{{ t('arbitrage.syncTpSl') }}">
                    üîÑ
                  </button>
                  <button
                    class="action-btn monitor-btn"
                    [class.monitoring-active]="position.monitoring?.enabled"
                    (click)="toggleMonitoringClick.emit(position)"
                    title="{{ t('arbitrage.toggleMonitoring') }}">
                    {{ position.monitoring?.enabled ? 'üëÅÔ∏è' : '‚ö´' }}
                  </button>
                  <button
                    class="action-btn stop-btn"
                    (click)="stopPositionClick.emit(position.positionId)"
                    title="{{ t('arbitrage.stopPosition') }}">
                    ‚úñÔ∏è
                  </button>
                }
              </td>
            </tr>

            <!-- Expanded Row Details -->
            @if (isRowExpanded(position.positionId)) {
              <tr class="expanded-row">
                <td colspan="7">
                  <div class="position-details">
                    <div class="details-grid">
                      <!-- Primary Exchange Details -->
                      <div class="detail-section primary-section">
                        <h4>{{ t('arbitrage.primary') }} ({{ position.primary.exchange }})</h4>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.entryPrice') }}:</span>
                          <span class="detail-value">${{ formatCurrency(position.primary.entryPrice) }}</span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.currentPrice') }}:</span>
                          <span class="detail-value">${{ formatCurrency(position.primary.currentPrice) }}</span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.quantity') }}:</span>
                          <span class="detail-value">{{ formatCurrency(position.primary.filledQuantity || position.primary.quantity) }}</span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.unrealizedPnl') }}:</span>
                          <span class="detail-value" [class.profit-positive]="(position.primary.unrealizedProfit || 0) > 0" [class.profit-negative]="(position.primary.unrealizedProfit || 0) < 0">
                            ${{ formatCurrency(position.primary.unrealizedProfit) }}
                          </span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.lastFundingPaid') }}:</span>
                          <span class="detail-value">
                            @if (hasFundingData(position)) {
                              ${{ formatCurrency(position.primary.lastFundingPaid) }}
                            } @else {
                              <span class="no-data">- </span>
                            }
                          </span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.totalFundingEarned') }}:</span>
                          <span class="detail-value" [class.profit-positive]="(position.primary.totalFundingEarned || 0) > 0">
                            @if (hasFundingData(position)) {
                              ${{ formatCurrency(position.primary.totalFundingEarned) }}
                            } @else {
                              <span class="no-data">- </span>
                            }
                          </span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.tradingFees') }}:</span>
                          <span class="detail-value profit-negative">-${{ formatCurrency(position.primary.tradingFees) }}</span>
                        </div>
                        @if (position.primary.liquidationPrice) {
                          <div class="detail-row">
                            <span class="detail-label">{{ t('arbitrage.liquidationPrice') }}:</span>
                            <span class="detail-value" [class.danger-zone]="position.primary.inDanger">
                              ${{ formatCurrency(position.primary.liquidationPrice) }}
                              @if (position.primary.proximityRatio) {
                                <span class="proximity-ratio">({{ (position.primary.proximityRatio * 100).toFixed(1) }}%)</span>
                              }
                            </span>
                          </div>
                        }
                      </div>

                      <!-- Hedge Exchange Details -->
                      <div class="detail-section hedge-section">
                        <h4>{{ t('arbitrage.hedge') }} ({{ position.hedge.exchange }})</h4>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.entryPrice') }}:</span>
                          <span class="detail-value">${{ formatCurrency(position.hedge.entryPrice) }}</span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.currentPrice') }}:</span>
                          <span class="detail-value">${{ formatCurrency(position.hedge.currentPrice) }}</span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.quantity') }}:</span>
                          <span class="detail-value">{{ formatCurrency(position.hedge.filledQuantity || position.hedge.quantity) }}</span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.unrealizedPnl') }}:</span>
                          <span class="detail-value" [class.profit-positive]="(position.hedge.unrealizedProfit || 0) > 0" [class.profit-negative]="(position.hedge.unrealizedProfit || 0) < 0">
                            ${{ formatCurrency(position.hedge.unrealizedProfit) }}
                          </span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.lastFundingPaid') }}:</span>
                          <span class="detail-value">
                            @if (hasFundingData(position)) {
                              ${{ formatCurrency(position.hedge.lastFundingPaid) }}
                            } @else {
                              <span class="no-data">- </span>
                            }
                          </span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.totalFundingEarned') }}:</span>
                          <span class="detail-value" [class.profit-positive]="(position.hedge.totalFundingEarned || 0) > 0">
                            @if (hasFundingData(position)) {
                              ${{ formatCurrency(position.hedge.totalFundingEarned) }}
                            } @else {
                              <span class="no-data">- </span>
                            }
                          </span>
                        </div>
                        <div class="detail-row">
                          <span class="detail-label">{{ t('arbitrage.tradingFees') }}:</span>
                          <span class="detail-value profit-negative">-${{ formatCurrency(position.hedge.tradingFees) }}</span>
                        </div>
                        @if (position.hedge.liquidationPrice) {
                          <div class="detail-row">
                            <span class="detail-label">{{ t('arbitrage.liquidationPrice') }}:</span>
                            <span class="detail-value" [class.danger-zone]="position.hedge.inDanger">
                              ${{ formatCurrency(position.hedge.liquidationPrice) }}
                              @if (position.hedge.proximityRatio) {
                                <span class="proximity-ratio">({{ (position.hedge.proximityRatio * 100).toFixed(1) }}%)</span>
                              }
                            </span>
                          </div>
                        }
                      </div>

                      <!-- Overall Position Metrics -->
                      <div class="detail-section metrics-section">
                        <h4>{{ t('arbitrage.totalMetrics') }}</h4>
                        <div class="detail-row highlight-row">
                          <span class="detail-label">{{ t('arbitrage.grossProfit') }}:</span>
                          <span class="detail-value profit-main" [class.profit-positive]="position.grossProfit > 0" [class.profit-negative]="position.grossProfit < 0">
                            ${{ formatCurrency(position.grossProfit) }}
                          </span>
                        </div>
                        <div class="detail-row highlight-row">
                          <span class="detail-label">{{ t('arbitrage.netProfit') }}:</span>
                          <span class="detail-value profit-main" [class.profit-positive]="position.netProfit > 0" [class.profit-negative]="position.netProfit < 0">
                            ${{ formatCurrency(position.netProfit) }}
                          </span>
                        </div>
                        @if (position.monitoring) {
                          <div class="detail-row">
                            <span class="detail-label">{{ t('arbitrage.monitoring') }}:</span>
                            <span class="detail-value">
                              <span class="monitoring-status" [class.enabled]="position.monitoring.enabled">
                                {{ position.monitoring.enabled ? t('arbitrage.enabled') : t('arbitrage.disabled') }}
                              </span>
                              @if (position.monitoring.lastCheck) {
                                <span class="last-check">({{ position.monitoring.lastCheck | relativeTime }})</span>
                              }
                            </span>
                          </div>
                        }
                      </div>
                    </div>
                  </div>
                </td>
              </tr>
            }
          }
        </tbody>
      </table>
    </div>
  }
</div>
