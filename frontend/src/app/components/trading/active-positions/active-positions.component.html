<div class="active-positions-container">
  <!-- Header -->
  <div class="positions-header">
    <h2 class="positions-title">{{ translate('arbitrage.activePositions') }}</h2>
    <div class="positions-actions">
      <ui-button
        variant="ghost"
        size="small"
        (clicked)="loadPositions()"
        [loading]="isLoading()"
        aria-label="Refresh positions">
        <span>
          <svg width="14" height="14" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
            <path d="M21.5 2V8M21.5 8H15.5M21.5 8L18.5 5C17.3 3.8 15.7 3 14 3C10.1 3 7 6.1 7 10M2.5 22V16M2.5 16H8.5M2.5 16L5.5 19C6.7 20.2 8.3 21 10 21C13.9 21 17 17.9 17 14" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
          </svg>
          {{ translate('funding.refresh') }}
        </span>
      </ui-button>
    </div>
  </div>

  <!-- Status Filter Tabs -->
  <div class="status-filters">
    <button
      class="status-filter-btn"
      [class.active]="selectedStatus() === 'ALL'"
      (click)="changeStatusFilter('ALL')">
      {{ translate('arbitrage.status.all') }} ({{ positions().length }})
    </button>
    <button
      class="status-filter-btn"
      [class.active]="selectedStatus() === 'ACTIVE'"
      (click)="changeStatusFilter('ACTIVE')">
      {{ translate('arbitrage.status.active') }} ({{ activeCount() }})
    </button>
    <button
      class="status-filter-btn"
      [class.active]="selectedStatus() === 'COMPLETED'"
      (click)="changeStatusFilter('COMPLETED')">
      {{ translate('arbitrage.status.completed') }} ({{ completedCount() }})
    </button>
    <button
      class="status-filter-btn"
      [class.active]="selectedStatus() === 'ERROR'"
      (click)="changeStatusFilter('ERROR')">
      {{ translate('arbitrage.status.error') }} ({{ errorCount() }})
    </button>
  </div>

  <!-- Positions Card -->
  <ui-card variant="outlined" class="positions-card">
    <ui-card-content>
      @if (isLoading() && positions().length === 0) {
        <div class="loading-state">
          <span>{{ translate('arbitrage.loading') }}</span>
        </div>
      } @else if (error()) {
        <div class="error-state">
          <p>{{ error() }}</p>
          <ui-button variant="primary" size="small" (clicked)="loadPositions()">
            {{ translate('funding.retry') }}
          </ui-button>
        </div>
      } @else if (filteredPositions().length === 0) {
        <div class="empty-state">
          <p>{{ translate('arbitrage.noPositions') }}</p>
          <p class="help-text">{{ translate('arbitrage.noPositionsHelp') }}</p>
        </div>
      } @else {
        <!-- Positions Table -->
        <div class="positions-table-wrapper">
          <table class="positions-table" role="table" aria-label="Active arbitrage positions">
            <thead>
              <tr>
                <th>{{ translate('arbitrage.table.symbol') }}</th>
                <th class="text-center">{{ translate('arbitrage.positions.primary') }}</th>
                <th class="text-center">{{ translate('arbitrage.positions.hedge') }}</th>
                <th class="text-center">{{ translate('arbitrage.entrySpread') }}</th>
                <th class="text-center">{{ translate('arbitrage.currentSpread') }}</th>
                <th class="text-center">{{ translate('arbitrage.unrealizedPnl') }}</th>
                <th class="text-center">{{ translate('arbitrage.holdingTime') }}</th>
                <th class="text-center">{{ translate('arbitrage.status.label') }}</th>
                <th class="text-center">{{ translate('arbitrage.actions') }}</th>
              </tr>
            </thead>
            <tbody>
              @for (position of filteredPositions(); track position.id) {
                <tr [class.position-active]="position.status === 'ACTIVE'">
                  <!-- Symbol -->
                  <td class="symbol-cell">
                    <span class="symbol-text">{{ position.symbol }}</span>
                    @if (position.currentPrimaryPrice) {
                      <span class="symbol-price">${{ position.currentPrimaryPrice.toFixed(2) }}</span>
                    }
                  </td>

                  <!-- Primary Exchange (SHORT) -->
                  <td class="text-center exchange-cell">
                    <div class="exchange-info">
                      <span class="exchange-name">{{ position.primaryExchange }}</span>
                      <span class="position-type short-position">SHORT</span>
                      <span class="leverage-badge">{{ position.primaryLeverage }}x</span>
                      @if (position.currentPrimaryPrice) {
                        <span class="price-value">${{ position.currentPrimaryPrice.toFixed(2) }}</span>
                      }
                    </div>
                  </td>

                  <!-- Hedge Exchange (LONG) -->
                  <td class="text-center exchange-cell">
                    <div class="exchange-info">
                      <span class="exchange-name">{{ position.hedgeExchange }}</span>
                      <span class="position-type long-position">LONG</span>
                      <span class="leverage-badge">{{ position.hedgeLeverage }}x</span>
                      @if (position.currentHedgePrice) {
                        <span class="price-value">${{ position.currentHedgePrice.toFixed(2) }}</span>
                      }
                    </div>
                  </td>

                  <!-- Entry Spread -->
                  <td class="text-center spread-cell">
                    <span class="spread-value">{{ getEntrySpreadDisplay(position) }}</span>
                  </td>

                  <!-- Current Spread -->
                  <td class="text-center spread-cell">
                    <span class="spread-value">{{ getCurrentSpreadDisplay(position) }}</span>
                  </td>

                  <!-- Unrealized P&L -->
                  <td class="text-center pnl-cell">
                    @if (position.status === 'ACTIVE') {
                      <span [class]="getPnlDisplay(position).textClass">
                        {{ formatPnl(getUnrealizedPnl(position)) }}
                      </span>
                    } @else {
                      <span [class]="getPnlDisplay(position).textClass">
                        {{ formatPnl(position.totalPnl) }}
                      </span>
                    }
                  </td>

                  <!-- Holding Time -->
                  <td class="text-center time-cell">
                    @if (position.status === 'ACTIVE') {
                      <span>{{ getHoldingTimeDisplay(position) }}</span>
                    } @else if (position.holdingTimeSeconds) {
                      <span>{{ (position.holdingTimeSeconds / 3600).toFixed(2) }}h</span>
                    } @else {
                      <span>N/A</span>
                    }
                  </td>

                  <!-- Status -->
                  <td class="text-center status-cell">
                    <span [class]="'status-badge ' + getStatusClass(position.status)">
                      {{ translate('arbitrage.status.' + position.status.toLowerCase()) }}
                    </span>
                    @if (position.errorMessage) {
                      <span class="error-message" [title]="position.errorMessage">⚠️</span>
                    }
                  </td>

                  <!-- Actions -->
                  <td class="text-center action-cell">
                    @if (position.status === 'ACTIVE') {
                      <ui-button
                        variant="ghost"
                        size="small"
                        (clicked)="openCloseDialog(position)"
                        className="close-position-btn">
                        {{ translate('arbitrage.close') }}
                      </ui-button>
                    } @else {
                      <span class="text-gray-400">-</span>
                    }
                  </td>
                </tr>
              }
            </tbody>
          </table>
        </div>
      }
    </ui-card-content>
  </ui-card>

  <!-- Close Position Confirmation Dialog -->
  <ui-dialog
    [open]="showCloseDialog()"
    (openChange)="showCloseDialog.set($event)"
    (close)="cancelClose()"
    [title]="translate('arbitrage.confirmClose')"
    size="small">

    <ui-dialog-content>
      @if (positionToClose()) {
        <div class="close-dialog-content">
          <p class="close-warning">{{ translate('arbitrage.closeWarning') }}</p>

          <div class="position-summary">
            <div class="summary-row">
              <span class="summary-label">{{ translate('arbitrage.table.symbol') }}:</span>
              <span class="summary-value">{{ positionToClose()!.symbol }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{ translate('arbitrage.positions.primary') }}:</span>
              <span class="summary-value">{{ positionToClose()!.primaryExchange }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{ translate('arbitrage.positions.hedge') }}:</span>
              <span class="summary-value">{{ positionToClose()!.hedgeExchange }}</span>
            </div>
            <div class="summary-row">
              <span class="summary-label">{{ translate('arbitrage.unrealizedPnl') }}:</span>
              <span [class]="getPnlDisplay(positionToClose()!).textClass">
                {{ formatPnl(getUnrealizedPnl(positionToClose()!)) }}
              </span>
            </div>
          </div>

          <p class="close-confirmation">{{ translate('arbitrage.closeConfirmation') }}</p>
        </div>
      }
    </ui-dialog-content>

    <ui-dialog-footer>
      <ui-button
        variant="ghost"
        (clicked)="cancelClose()"
        [disabled]="isClosing()">
        {{ translate('fundingRates.actions.cancel') }}
      </ui-button>
      <ui-button
        variant="primary"
        (clicked)="confirmClose()"
        [loading]="isClosing()">
        {{ translate('arbitrage.closePosition') }}
      </ui-button>
    </ui-dialog-footer>
  </ui-dialog>
</div>
