<div class="funding-revenue-container">
  <!-- Header -->
  <div class="funding-revenue-header">
    <h2 class="funding-revenue-title">Funding Arbitrage Revenue</h2>
    <div class="funding-revenue-actions">
      <ui-button
        variant="ghost"
        size="small"
        (clicked)="toggleFilters()"
        [attr.aria-expanded]="showFilters()">
        <span>{{ showFilters() ? 'Hide Filters' : 'Show Filters' }}</span>
      </ui-button>
      <ui-button
        variant="primary"
        size="small"
        (clicked)="refreshRevenue()"
        [loading]="isLoading()">
        <span>Refresh</span>
      </ui-button>
    </div>
  </div>

  <!-- Filters Panel -->
  @if (showFilters()) {
    <ui-card variant="outlined" class="filters-card">
      <ui-card-content>
        <div class="filters-container">
          <div class="filter-group">
            <label class="filter-label">Start Date</label>
            <input
              type="date"
              class="filter-input"
              [(ngModel)]="startDate"
            />
          </div>

          <div class="filter-group">
            <label class="filter-label">End Date</label>
            <input
              type="date"
              class="filter-input"
              [(ngModel)]="endDate"
            />
          </div>

          <div class="filter-group">
            <label class="filter-label">Exchange</label>
            <select class="filter-input filter-select" [(ngModel)]="selectedExchange">
              <option value="">All Exchanges</option>
              @for (exchange of availableExchanges(); track exchange) {
                <option [value]="exchange">{{ exchange }}</option>
              }
            </select>
          </div>

          <div class="filter-group">
            <label class="filter-label">Symbol</label>
            <select class="filter-input filter-select" [(ngModel)]="selectedSymbol">
              <option value="">All Symbols</option>
              @for (symbol of availableSymbols(); track symbol) {
                <option [value]="symbol">{{ symbol }}</option>
              }
            </select>
          </div>

          <div class="filter-actions">
            <ui-button variant="primary" size="small" (clicked)="applyFilters()">
              Apply Filters
            </ui-button>
            <ui-button variant="ghost" size="small" (clicked)="clearFilters()">
              Clear
            </ui-button>
          </div>
        </div>
      </ui-card-content>
    </ui-card>
  }

  <!-- Loading State -->
  @if (isLoading()) {
    <div class="loading-state">
      <p>Loading revenue data...</p>
    </div>
  }

  <!-- Error State -->
  @if (error() && !isLoading()) {
    <div class="error-state">
      <p>{{ error() }}</p>
      <ui-button variant="primary" size="small" (clicked)="refreshRevenue()">
        Retry
      </ui-button>
    </div>
  }

  <!-- Revenue Data -->
  @if (revenueData() && !isLoading() && !error()) {
    <!-- Summary Cards -->
    <div class="summary-grid">
      <!-- Total Revenue -->
      <ui-card variant="elevated" class="metric-card revenue-card">
        <ui-card-content>
          <div class="metric-header">
            <span class="metric-icon">üí∞</span>
            <span class="metric-label">Total Revenue</span>
          </div>
          <div class="metric-value" [class]="getValueClass(summary()!.totalRevenue)">
            {{ formatCurrency(summary()!.totalRevenue) }}
          </div>
          <div class="metric-subtext">
            Net: {{ formatCurrency(netProfit()) }}
          </div>
        </ui-card-content>
      </ui-card>

      <!-- Total Deals -->
      <ui-card variant="elevated" class="metric-card">
        <ui-card-content>
          <div class="metric-header">
            <span class="metric-icon">üìä</span>
            <span class="metric-label">Total Deals</span>
          </div>
          <div class="metric-value">
            {{ summary()!.totalDeals }}
          </div>
          <div class="metric-subtext">
            Profitable: {{ summary()!.profitableDeals }} | Losing: {{ summary()!.losingDeals }}
          </div>
        </ui-card-content>
      </ui-card>

      <!-- Win Rate -->
      <ui-card variant="elevated" class="metric-card">
        <ui-card-content>
          <div class="metric-header">
            <span class="metric-icon">üéØ</span>
            <span class="metric-label">Win Rate</span>
          </div>
          <div class="metric-value" [class]="getWinRateClass(summary()!.winRate)">
            {{ formatPercent(summary()!.winRate) }}
          </div>
          <div class="metric-subtext">
            {{ summary()!.profitableDeals }} / {{ summary()!.totalDeals }} trades
          </div>
        </ui-card-content>
      </ui-card>

      <!-- Total Funding Earned -->
      <ui-card variant="elevated" class="metric-card">
        <ui-card-content>
          <div class="metric-header">
            <span class="metric-icon">üíµ</span>
            <span class="metric-label">Funding Earned</span>
          </div>
          <div class="metric-value positive">
            {{ formatCurrency(summary()!.totalFundingEarned) }}
          </div>
          <div class="metric-subtext">
            From funding payments
          </div>
        </ui-card-content>
      </ui-card>

      <!-- Total Trading P&L -->
      <ui-card variant="elevated" class="metric-card">
        <ui-card-content>
          <div class="metric-header">
            <span class="metric-icon">üìà</span>
            <span class="metric-label">Trading P&L</span>
          </div>
          <div class="metric-value" [class]="getValueClass(summary()!.totalTradingPnl)">
            {{ formatCurrency(summary()!.totalTradingPnl) }}
          </div>
          <div class="metric-subtext">
            Price movement impact
          </div>
        </ui-card-content>
      </ui-card>

      <!-- Average Revenue Per Deal -->
      <ui-card variant="elevated" class="metric-card">
        <ui-card-content>
          <div class="metric-header">
            <span class="metric-icon">üìä</span>
            <span class="metric-label">Avg per Deal</span>
          </div>
          <div class="metric-value" [class]="getValueClass(summary()!.avgRevenuePerDeal)">
            {{ formatCurrency(summary()!.avgRevenuePerDeal) }}
          </div>
          <div class="metric-subtext">
            Average profit per trade
          </div>
        </ui-card-content>
      </ui-card>
    </div>

    <!-- Best and Worst Deals -->
    @if (summary()!.bestDeal || summary()!.worstDeal) {
      <div class="best-worst-grid">
        <!-- Best Deal -->
        @if (summary()!.bestDeal) {
          <ui-card variant="elevated" class="deal-highlight-card best-deal-card">
            <ui-card-header>
              <ui-card-title>Best Deal üèÜ</ui-card-title>
            </ui-card-header>
            <ui-card-content>
              <div class="deal-highlight-info">
                <div class="deal-highlight-row">
                  <span class="deal-label">Symbol:</span>
                  <span class="deal-value">{{ summary()!.bestDeal!.symbol }}</span>
                </div>
                <div class="deal-highlight-row">
                  <span class="deal-label">Revenue:</span>
                  <span class="deal-value positive">{{ formatCurrency(summary()!.bestDeal!.revenue) }}</span>
                </div>
                <div class="deal-highlight-row">
                  <span class="deal-label">Date:</span>
                  <span class="deal-value">{{ formatDate(summary()!.bestDeal!.date) }}</span>
                </div>
              </div>
            </ui-card-content>
          </ui-card>
        }

        <!-- Worst Deal -->
        @if (summary()!.worstDeal) {
          <ui-card variant="elevated" class="deal-highlight-card worst-deal-card">
            <ui-card-header>
              <ui-card-title>Worst Deal üìâ</ui-card-title>
            </ui-card-header>
            <ui-card-content>
              <div class="deal-highlight-info">
                <div class="deal-highlight-row">
                  <span class="deal-label">Symbol:</span>
                  <span class="deal-value">{{ summary()!.worstDeal!.symbol }}</span>
                </div>
                <div class="deal-highlight-row">
                  <span class="deal-label">Revenue:</span>
                  <span class="deal-value negative">{{ formatCurrency(summary()!.worstDeal!.revenue) }}</span>
                </div>
                <div class="deal-highlight-row">
                  <span class="deal-label">Date:</span>
                  <span class="deal-value">{{ formatDate(summary()!.worstDeal!.date) }}</span>
                </div>
              </div>
            </ui-card-content>
          </ui-card>
        }
      </div>
    }

    <!-- Revenue by Symbol -->
    @if (bySymbol().length > 0) {
      <ui-card variant="outlined" class="data-table-card">
        <ui-card-header>
          <ui-card-title>Revenue by Symbol</ui-card-title>
        </ui-card-header>
        <ui-card-content>
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Symbol</th>
                  <th class="text-right">Deals</th>
                  <th class="text-right">Total Revenue</th>
                  <th class="text-right">Avg Revenue</th>
                  <th class="text-right">Funding Earned</th>
                </tr>
              </thead>
              <tbody>
                @for (item of bySymbol(); track item.symbol) {
                  <tr>
                    <td class="symbol-cell">{{ item.symbol }}</td>
                    <td class="text-right">{{ item.deals }}</td>
                    <td class="text-right" [class]="getValueClass(item.revenue)">
                      {{ formatCurrency(item.revenue) }}
                    </td>
                    <td class="text-right" [class]="getValueClass(item.avgRevenue)">
                      {{ formatCurrency(item.avgRevenue) }}
                    </td>
                    <td class="text-right positive">
                      {{ formatCurrency(item.fundingEarned) }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </ui-card-content>
      </ui-card>
    }

    <!-- Revenue by Exchange -->
    @if (byExchange().length > 0) {
      <ui-card variant="outlined" class="data-table-card">
        <ui-card-header>
          <ui-card-title>Revenue by Exchange</ui-card-title>
        </ui-card-header>
        <ui-card-content>
          <div class="table-wrapper">
            <table class="data-table">
              <thead>
                <tr>
                  <th>Exchange</th>
                  <th class="text-right">Deals</th>
                  <th class="text-right">Total Revenue</th>
                  <th class="text-right">Avg Revenue</th>
                </tr>
              </thead>
              <tbody>
                @for (item of byExchange(); track item.exchange) {
                  <tr>
                    <td class="exchange-cell">
                      <span class="exchange-badge" [class]="'badge-' + item.exchange.toLowerCase()">
                        {{ item.exchange }}
                      </span>
                    </td>
                    <td class="text-right">{{ item.deals }}</td>
                    <td class="text-right" [class]="getValueClass(item.revenue)">
                      {{ formatCurrency(item.revenue) }}
                    </td>
                    <td class="text-right" [class]="getValueClass(item.avgRevenue)">
                      {{ formatCurrency(item.avgRevenue) }}
                    </td>
                  </tr>
                }
              </tbody>
            </table>
          </div>
        </ui-card-content>
      </ui-card>
    }

    <!-- Individual Deals -->
    @if (deals().length > 0) {
      <ui-card variant="outlined" class="deals-card">
        <ui-card-header>
          <ui-card-title>Completed Deals ({{ deals().length }})</ui-card-title>
        </ui-card-header>
        <ui-card-content>
          <div class="deals-list">
            @for (deal of deals(); track deal.id) {
              <div class="deal-item" [class.expanded]="isDealExpanded(deal.id)">
                <!-- Deal Header (always visible) -->
                <div class="deal-header" (click)="toggleDealExpansion(deal.id)">
                  <div class="deal-main-info">
                    <span class="deal-symbol">{{ deal.symbol }}</span>
                    <span class="deal-exchanges">
                      {{ deal.primaryExchange }} ‚Üî {{ deal.hedgeExchange }}
                    </span>
                    <span class="deal-position-type" [class]="deal.positionType">
                      {{ deal.positionType.toUpperCase() }}
                    </span>
                  </div>
                  <div class="deal-summary-info">
                    <span class="deal-pnl" [class]="getValueClass(deal.realizedPnl)">
                      {{ formatCurrency(deal.realizedPnl) }}
                    </span>
                    <span class="deal-expand-icon">
                      {{ isDealExpanded(deal.id) ? '‚ñ≤' : '‚ñº' }}
                    </span>
                  </div>
                </div>

                <!-- Deal Details (expandable) -->
                @if (isDealExpanded(deal.id)) {
                  <div class="deal-details">
                    <div class="deal-details-grid">
                      <div class="detail-row">
                        <span class="detail-label">Quantity:</span>
                        <span class="detail-value">{{ formatNumber(deal.quantity, 6) }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Funding Rate:</span>
                        <span class="detail-value">{{ formatPercent(deal.fundingRate * 100) }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Entry Price:</span>
                        <span class="detail-value">{{ formatCurrency(deal.entryPrice) }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Hedge Entry:</span>
                        <span class="detail-value">{{ formatCurrency(deal.hedgeEntryPrice) }}</span>
                      </div>
                      @if (deal.primaryExitPrice !== null) {
                        <div class="detail-row">
                          <span class="detail-label">Exit Price:</span>
                          <span class="detail-value">{{ formatCurrency(deal.primaryExitPrice) }}</span>
                        </div>
                      }
                      @if (deal.hedgeExitPrice !== null) {
                        <div class="detail-row">
                          <span class="detail-label">Hedge Exit:</span>
                          <span class="detail-value">{{ formatCurrency(deal.hedgeExitPrice) }}</span>
                        </div>
                      }
                      <div class="detail-row highlight">
                        <span class="detail-label">Funding Earned:</span>
                        <span class="detail-value positive">{{ formatCurrency(deal.fundingEarned) }}</span>
                      </div>
                      <div class="detail-row highlight">
                        <span class="detail-label">Realized P&L:</span>
                        <span class="detail-value" [class]="getValueClass(deal.realizedPnl)">
                          {{ formatCurrency(deal.realizedPnl) }}
                        </span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Primary Fees:</span>
                        <span class="detail-value">{{ formatCurrency(deal.primaryTradingFees) }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Hedge Fees:</span>
                        <span class="detail-value">{{ formatCurrency(deal.hedgeTradingFees) }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Executed At:</span>
                        <span class="detail-value">{{ formatDate(deal.executedAt) }}</span>
                      </div>
                      <div class="detail-row">
                        <span class="detail-label">Closed At:</span>
                        <span class="detail-value">{{ formatDate(deal.closedAt) }}</span>
                      </div>
                      @if (deal.duration !== null) {
                        <div class="detail-row">
                          <span class="detail-label">Duration:</span>
                          <span class="detail-value">{{ formatDuration(deal.duration) }}</span>
                        </div>
                      }
                    </div>
                  </div>
                }
              </div>
            }
          </div>
        </ui-card-content>
      </ui-card>
    }

    <!-- Empty State -->
    @if (deals().length === 0) {
      <div class="empty-state">
        <p>No completed deals found for the selected filters.</p>
        <p class="help-text">Try adjusting your date range or clearing filters.</p>
      </div>
    }
  }
</div>
