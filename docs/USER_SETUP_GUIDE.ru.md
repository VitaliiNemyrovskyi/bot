# Руководство по настройке - Платформа торговых ботов для криптовалют

## Содержание

1. [Обзор](#обзор)
2. [Что это за приложение?](#что-это-за-приложение)
3. [Требования](#требования)
4. [Настройка Backend](#настройка-backend)
5. [Настройка Frontend](#настройка-frontend)
6. [Настройка бирж](#настройка-бирж)
7. [Запуск приложения](#запуск-приложения)
8. [Использование приложения](#использование-приложения)
9. [Устранение неполадок](#устранение-неполадок)
10. [Лучшие практики безопасности](#лучшие-практики-безопасности)

---

## Обзор

Это полнофункциональная платформа торговых ботов для криптовалют, которая обеспечивает автоматизированные торговые стратегии, включая арбитраж ставок финансирования. Приложение состоит из:

- **Backend**: API-сервер Next.js с базой данных PostgreSQL
- **Frontend**: Веб-интерфейс на базе Angular
- **Поддерживаемые биржи**: Bybit, Binance, BingX, OKX, Kraken, Coinbase

---

## Что это за приложение?

Эта платформа предоставляет:

### Основные функции
- **Аутентификация**: Безопасная аутентификация пользователей с JWT и Google OAuth
- **Интеграция с биржами**: Подключение нескольких аккаунтов криптовалютных бирж
- **Арбитраж финансирования**: Автоматизированные стратегии арбитража ставок финансирования
- **Сеточные торговые боты**: Настраиваемые сеточные торговые боты
- **Бэктестинг**: Тестирование торговых стратегий на исторических данных
- **Данные в реальном времени**: Реальные ставки финансирования и графики цен
- **Управление портфелем**: Отслеживание ваших позиций и P&L на биржах

### Стратегия арбитража финансирования
Платформа специализируется на арбитраже ставок финансирования - получении прибыли от периодических платежей финансирования в бессрочных фьючерсных контрактах. Бот:
1. Открывает позицию на одной бирже (основная)
2. Открывает противоположную позицию на другой бирже (хедж)
3. Собирает платежи финансирования
4. Закрывает обе позиции после финансирования

---

## Требования

### Необходимое программное обеспечение

1. **Node.js** (v18 или выше)
   - Скачать с: https://nodejs.org/
   - Проверить установку: `node --version`

2. **PostgreSQL** (v14 или выше)
   - Скачать с: https://www.postgresql.org/download/
   - Проверить установку: `psql --version`

3. **Git**
   - Скачать с: https://git-scm.com/
   - Проверить установку: `git --version`

### Аккаунты на биржах

Вам понадобятся API ключи как минимум от одной поддерживаемой биржи:
- **Bybit**: https://www.bybit.com/
- **BingX**: https://bingx.com/
- **Binance**: https://www.binance.com/
- **OKX**: https://www.okx.com/

**Важно**: Начните с тестовых/демо аккаунтов, чтобы избежать риска потери реальных средств во время обучения.

---

## Настройка Backend

### 1. Установка зависимостей

```bash
cd backend
npm install
```

### 2. Настройка базы данных PostgreSQL

#### Вариант А: Локальная установка PostgreSQL

1. Создайте базу данных:
```bash
psql -U postgres
CREATE DATABASE auth_app_local;
\q
```

2. Проверьте подключение:
```bash
psql -U postgres -d auth_app_local -c "SELECT 1"
```

#### Вариант Б: Облачная PostgreSQL (Railway, Supabase и т.д.)

1. Создайте экземпляр базы данных у предпочитаемого облачного провайдера
2. Запишите строку подключения (формат: `postgresql://username:password@host:port/database`)

### 3. Настройка переменных окружения

Создайте файл `.env` в директории `backend`:

```bash
cp .env.local .env
```

Отредактируйте файл `.env` своей конфигурацией:

```env
# Окружение
NODE_ENV=development
PORT=3000

# Подключение к базе данных
# Замените на ваши реальные учетные данные PostgreSQL
DATABASE_URL="postgresql://postgres:ВАШ_ПАРОЛЬ@localhost:5432/auth_app_local"

# Детали подключения PostgreSQL (если используете отдельные переменные)
POSTGRES_HOST=localhost
POSTGRES_PORT=5432
POSTGRES_DB=auth_app_local
POSTGRES_USER=postgres
POSTGRES_PASSWORD=ВАШ_ПАРОЛЬ

# Конфигурация JWT
# Сгенерируйте безопасную случайную строку (минимум 32 символа)
JWT_SECRET=ваш-супер-секретный-jwt-ключ-для-локальной-разработки-замените-это
JWT_EXPIRES_IN=1d

# Google OAuth (Необязательно)
# Получите учетные данные на: https://console.cloud.google.com/
GOOGLE_CLIENT_ID=ваш-google-client-id
GOOGLE_CLIENT_SECRET=ваш-google-client-secret

# URL Frontend
FRONTEND_URL=http://localhost:4200

# Ключ шифрования для хранения API ключей
# ВАЖНО: Должен быть ровно 32 символа или больше
# Сгенерируйте с помощью: node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
ENCRYPTION_KEY=a1b2c3d4e5f6g7h8i9j0k1l2m3n4o5p6q7r8s9t0u1v2w3x4y5z6a7b8c9d0e1f2
```

### 4. Генерация ключа шифрования

Выполните эту команду для генерации безопасного ключа шифрования:

```bash
node -e "console.log(require('crypto').randomBytes(32).toString('hex'))"
```

Скопируйте вывод и замените значение `ENCRYPTION_KEY` в вашем файле `.env`.

### 5. Настройка схемы базы данных

```bash
# Сгенерируйте клиент Prisma
npx prisma generate

# Применить схему к базе данных
npx prisma db push

# (Необязательно) Откройте Prisma Studio для просмотра базы данных
npx prisma studio
```

### 6. Запуск Backend сервера

```bash
npm run dev
```

Backend теперь должен работать на `http://localhost:3000`

---

## Настройка Frontend

### 1. Установка зависимостей

```bash
cd frontend
npm install
```

### 2. Настройка окружения

Отредактируйте `frontend/src/environments/environment.ts`:

```typescript
import { appConfig } from '../app/config/app.config';

export const environment = {
  production: false,
  apiUrl: 'http://localhost:3000/api',
  googleClientId: 'ваш-google-client-id', // Необязательно: для Google OAuth
  appName: 'Trading Bot - Development'
};
```

### 3. Запуск Frontend сервера

```bash
npm start
```

Frontend теперь должен работать на `http://localhost:4200`

---

## Настройка бирж

### 1. Создание API ключей биржи

#### Для Bybit:

1. Войдите в Bybit
2. Перейдите в Управление API: https://www.bybit.com/app/user/api-management
3. Создайте новый API ключ с этими разрешениями:
   - **Read**: Position, Order, Wallet
   - **Write**: Trade, Position
4. **Важно**: Включите торговлю "Derivatives"
5. Сохраните ваш API ключ и секрет надежно

#### Для BingX:

1. Войдите в BingX
2. Перейдите в Управление API: https://bingx.com/en-us/account/api/
3. Создайте новый API ключ с этими разрешениями:
   - **Perpetual Futures**: Read + Write
4. Сохраните ваш API ключ и секрет надежно

#### Для Binance:

1. Войдите в Binance
2. Перейдите в Управление API: https://www.binance.com/en/my/settings/api-management
3. Создайте новый API ключ
4. Включите торговлю "Futures"
5. Сохраните ваш API ключ и секрет надежно

### 2. Добавление API ключей в приложение

1. Откройте приложение на `http://localhost:4200`
2. Зарегистрируйтесь/Войдите в свой аккаунт
3. Перейдите в **Настройки** → **Подключения к биржам**
4. Нажмите **Добавить учетные данные биржи**
5. Заполните форму:
   - **Биржа**: Выберите вашу биржу (например, BYBIT)
   - **Окружение**: Выберите TESTNET (рекомендуется) или MAINNET
   - **API ключ**: Вставьте ваш API ключ
   - **API секрет**: Вставьте ваш API секрет
   - **Метка**: Дайте дружественное имя (например, "Bybit Testnet Main")
   - **Активен**: Отметьте, чтобы установить как активный
6. Нажмите **Сохранить**

**Важные примечания по безопасности**:
- API ключи шифруются перед сохранением с использованием AES-256-CBC
- Никогда не делитесь своими API ключами ни с кем
- Используйте ограничения IP whitelist на стороне биржи, когда возможно
- Начните с тестовых аккаунтов
- Включайте только необходимые разрешения (не давайте разрешение на вывод)

---

## Запуск приложения

### Режим разработки

#### Терминал 1: Backend
```bash
cd backend
npm run dev
```

#### Терминал 2: Frontend
```bash
cd frontend
npm start
```

### Производственный режим

#### Сборка Backend
```bash
cd backend
npm run build
npm start
```

#### Сборка Frontend
```bash
cd frontend
npm run build
# Раздайте папку dist с веб-сервером
```

---

## Использование приложения

### 1. Создайте свой аккаунт

1. Откройте `http://localhost:4200`
2. Нажмите **Регистрация**
3. Заполните email и пароль
4. Подтвердите ваш аккаунт (если включена верификация email)

### 2. Подключите аккаунты бирж

Следуйте шагам в разделе [Настройка бирж](#настройка-бирж)

### 3. Настройка арбитража финансирования

1. Перейдите в **Торговля** → **Ставки финансирования**
2. Просмотрите доступные возможности ставок финансирования
3. Нажмите на символ, чтобы увидеть детали
4. Нажмите **Подписаться**, чтобы настроить арбитраж
5. Настройте:
   - **Основная биржа**: Где вы получите платеж финансирования
   - **Хедж биржа**: Где вы займете противоположную позицию
   - **Количество**: Сколько торговать
   - **Плечо**: Множитель (рекомендуется 1-20x, по умолчанию 3x)
6. Нажмите **Подтвердить**

### 4. Мониторинг ваших позиций

1. Перейдите в **Панель управления**
2. Просмотрите активные подписки
3. Мониторьте P&L и заработанное финансирование
4. Проверьте статус позиции

### 5. Просмотр истории

1. Перейдите в **Торговля** → **История**
2. Проверьте закрытые позиции
3. Проанализируйте метрики производительности

---

## Устранение неполадок

### Проблемы с подключением к базе данных

**Ошибка**: `Connection refused` или `ECONNREFUSED`

**Решение**:
1. Проверьте, что PostgreSQL запущен:
   ```bash
   # macOS
   brew services list

   # Linux
   sudo systemctl status postgresql

   # Windows
   # Проверьте приложение Services для службы PostgreSQL
   ```

2. Тест подключения:
   ```bash
   psql -U postgres -d auth_app_local -c "SELECT 1"
   ```

3. Проверьте, что DATABASE_URL в `.env` соответствует вашей конфигурации PostgreSQL

### Backend не запускается

**Ошибка**: `Port 3000 already in use`

**Решение**:
1. Завершите процесс, использующий порт 3000:
   ```bash
   # macOS/Linux
   lsof -ti:3000 | xargs kill -9

   # Windows
   netstat -ano | findstr :3000
   taskkill /PID <PID> /F
   ```

2. Или измените порт в `.env`:
   ```env
   PORT=3001
   ```

### Ошибки API биржи

**Ошибка**: `Invalid signature` или `Authentication failed`

**Решение**:
1. Проверьте, что API ключи правильные (без лишних пробелов)
2. Проверьте разрешения API ключа на бирже
3. Проверьте, что системное время синхронизировано (биржи требуют точное время)
4. Проверьте, ограничен ли API ключ по IP (добавьте ваш IP в whitelist)

**Ошибка**: `Insufficient balance`

**Решение**:
1. Убедитесь, что у вас есть средства на аккаунте биржи
2. Проверьте, что используете правильный тип аккаунта (Spot vs Futures)
3. Проверьте, что маржа доступна для торговли с плечом

**Ошибка**: `Leverage cannot be changed when there are open positions`

**Решение**:
1. Закройте все открытые позиции для этого символа
2. Затем повторите подписку на арбитраж
3. Или используйте другой символ

### Ошибки сборки Frontend

**Ошибка**: `Module not found` или `Can't resolve...`

**Решение**:
```bash
cd frontend
rm -rf node_modules package-lock.json
npm install
```

### Проблемы с Prisma

**Ошибка**: `Prisma Client not generated`

**Решение**:
```bash
cd backend
npx prisma generate
npx prisma db push
```

---

## Лучшие практики безопасности

### 1. Безопасность API ключей

- Никогда не коммитьте файлы `.env` в git
- Используйте `.env.local` для локальной разработки
- Периодически меняйте API ключи
- Используйте отдельные ключи для testnet и mainnet
- Включайте IP whitelisting на биржах
- Используйте ключи только для чтения, где возможно
- Никогда не давайте разрешения на вывод

### 2. Безопасность базы данных

- Используйте надежные пароли PostgreSQL
- Не выставляйте порт базы данных в интернет
- Регулярные резервные копии
- Используйте SSL подключения в production

### 3. Безопасность приложения

- Немедленно измените JWT_SECRET по умолчанию
- Используйте надежные пароли
- Включите двухфакторную аутентификацию (когда доступна)
- Держите Node.js и зависимости обновленными
- Мониторьте уязвимости безопасности: `npm audit`

### 4. Безопасность торговли

- Начинайте с небольших сумм
- Всегда тестируйте сначала на testnet
- Устанавливайте лимиты stop-loss
- Регулярно мониторьте позиции
- Никогда не инвестируйте больше, чем можете позволить себе потерять

### 5. Переменные окружения

Никогда не делитесь и не коммитьте:
- `JWT_SECRET`
- `ENCRYPTION_KEY`
- `DATABASE_URL`
- `GOOGLE_CLIENT_SECRET`
- Любые API ключи или секреты

---

## Дополнительные ресурсы

### Документация

- **Prisma**: https://www.prisma.io/docs/
- **Next.js**: https://nextjs.org/docs
- **Angular**: https://angular.io/docs
- **Bybit API**: https://bybit-exchange.github.io/docs/v5/intro
- **BingX API**: https://bingx-api.github.io/docs/

### Поддержка

- Проверьте `LEVERAGE_SYNC_VERIFICATION.md` для деталей синхронизации плеча
- Просмотрите `LEVERAGE_SYNC_IMPLEMENTATION.md` для технических деталей
- См. проектный README.md для API endpoints

### Разработка

- Frontend работает на порту 4200
- Backend работает на порту 3000
- База данных обычно на порту 5432
- Горячая перезагрузка включена в режиме разработки

---

## Контрольный список быстрого старта

- [ ] Node.js установлен (v18+)
- [ ] PostgreSQL установлен и работает
- [ ] База данных создана (`auth_app_local`)
- [ ] Файл `.env` Backend настроен
- [ ] Ключ шифрования сгенерирован
- [ ] Зависимости Backend установлены (`npm install`)
- [ ] Схема базы данных создана (`npx prisma db push`)
- [ ] Backend сервер запущен (`npm run dev`)
- [ ] Зависимости Frontend установлены
- [ ] Окружение Frontend настроено
- [ ] Frontend сервер запущен (`npm start`)
- [ ] Аккаунт создан в приложении
- [ ] API ключи биржи получены
- [ ] Учетные данные биржи добавлены в приложение
- [ ] Первый тестовый арбитраж на testnet
- [ ] Мониторинг результатов

---

**Поздравляем!** Теперь вы готовы использовать платформу торговых ботов для криптовалют.

По вопросам или проблемам, пожалуйста, просмотрите раздел устранения неполадок или проверьте документацию проекта.

**Отказ от ответственности**: Торговля криптовалютами включает существенный риск. Это программное обеспечение предоставляется как есть без каких-либо гарантий. Всегда тщательно тестируйте на testnet перед использованием реальных средств.
